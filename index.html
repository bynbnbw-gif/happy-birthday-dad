<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> 转 砖, !</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom Hebrew Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <!-- Firebase Imports for Firestore and Auth -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, EmailAuthProvider, linkWithCredential, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 专转 转 住转 注 ( 砖转砖 )
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        window.db = null;
        window.auth = null;
        window.currentUser = null;
        window.collectionPath = `artifacts/${appId}/public/data/birthday_blessings`;

        let synth = null;
        
        // --- 驻拽爪转 注专 转 (砖 砖祝 转 -window) ---

        function initializeSynth() {
            if (synth === null) {
                synth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "square" },
                    envelope: {
                        attack: 0.01, decay: 0.1, sustain: 0.01, release: 0.1
                    }
                }).toDestination();
                
                document.body.addEventListener('click', () => {
                    if (Tone.context.state !== 'running') {
                        Tone.start().catch(e => console.error("Could not start Tone.js:", e));
                    }
                }, { once: true });
            }
        }

        // 驻转转 
        function showAuthModal() {
            document.getElementById('auth-modal').classList.remove('hidden');
            document.getElementById('modal-message').textContent = '';
        }

        // 住专转 
        function hideAuthModal() {
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('auth-form').reset();
            document.getElementById('modal-message').textContent = '';
        }

        // 驻 爪
        async function handleLogout() {
            // 祝 砖砖  UI 拽 confirm()
            if (confirm(' 转  砖专爪 转转拽?')) { 
                await signOut(window.auth);
            }
        }

        // 驻 转专转  专砖
        async function handleLoginRegister(event) {
            event.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const action = document.querySelector('input[name="auth-action"]:checked').value;
            const modalMessage = document.getElementById('modal-message');

            modalMessage.textContent = '...注 拽砖';
            modalMessage.classList.remove('text-red-600', 'text-green-600');
            modalMessage.classList.add('text-blue-600');


            try {
                if (action === 'register') {
                    // 专砖: 爪专 砖转砖 砖
                    const userCredential = await createUserWithEmailAndPassword(window.auth, email, password);
                    
                    //  砖转砖   , 砖 转 转 砖 砖
                    if (window.currentUser && window.currentUser.isAnonymous) {
                        const credential = EmailAuthProvider.credential(email, password);
                        await linkWithCredential(window.currentUser, credential);
                    }
                    modalMessage.textContent = '专砖转 转专转 爪!';

                } else {
                    // 转专转
                    await signInWithEmailAndPassword(window.auth, email, password);
                    modalMessage.textContent = '转专转 爪!';
                }
                
                modalMessage.classList.remove('text-blue-600');
                modalMessage.classList.add('text-green-600');
                
                setTimeout(hideAuthModal, 1500);

            } catch (error) {
                console.error("Auth Error:", error);
                let errorMessage;
                switch (error.code) {
                    case 'auth/email-already-in-use': errorMessage = ' 专 砖砖. 住 转专.'; break;
                    case 'auth/invalid-email': errorMessage = '转转   转拽.'; break;
                    case 'auth/weak-password': errorMessage = '住住 砖  ( 6 转).'; break;
                    case 'auth/user-not-found': 
                    case 'auth/wrong-password': errorMessage = '砖 砖转砖  住住 砖.'; break;
                    default: errorMessage = `砖转 转: ${error.message}`;
                }
                modalMessage.classList.remove('text-blue-600', 'text-green-600');
                modalMessage.classList.add('text-red-600');
                modalMessage.textContent = errorMessage;
            }
        }


        // 砖驻转 驻拽爪转 拽  (window)
        window.showAuthModal = showAuthModal; 
        window.hideAuthModal = hideAuthModal;
        window.handleLogout = handleLogout;
        window.handleLoginRegister = handleLoginRegister;
        // ----------------------------------------------------------------------


        // --- 注 砖拽 砖转砖 转 ---
        function updateAuthUI(user) {
            const userIdDisplayEl = document.getElementById('user-id-display');
            const authButton = document.getElementById('auth-button');
            const authStatusText = document.getElementById('auth-status-text');
            const statusEl = document.getElementById('status-message');

            if (user) {
                window.currentUser = user;
                const isAnonymous = user.isAnonymous;
                //  砖转砖 砖  (专  专砖), 爪 转. 专转, 专.
                const displayName = user.email || '专 ()'; 
                
                if (isAnonymous) {
                    authButton.textContent = '转专转 / 专砖';
                    authButton.onclick = window.showAuthModal; // 砖砖 -window
                    authStatusText.innerHTML = `<span class="text-sm text-yellow-600 font-semibold">专 : 专.</span>`;
                } else {
                    authButton.textContent = '爪 (Logout)';
                    authButton.onclick = window.handleLogout; // 砖砖 -window
                    authStatusText.innerHTML = `<span class="text-sm text-green-600 font-semibold">专 : ${displayName}</span>`;
                }

                userIdDisplayEl.textContent = ` 砖转砖: ${user.uid}`;
                statusEl.textContent = '专 爪. 注 专转.';
                statusEl.classList.remove('text-blue-600', 'text-yellow-600');
                statusEl.classList.add('text-green-600');
                userIdDisplayEl.classList.remove('hidden');
            } else {
                //   砖转砖, 住 转
                signInAnonymously(window.auth); 
            }
        }
        
        // --- 转 Firebase 转专转 ---
        async function initFirebase() {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = '...转 专 住 转';
            statusEl.classList.remove('hidden', 'text-red-600');
            statusEl.classList.add('text-yellow-600');

            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase configuration is missing.");
                }

                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                setLogLevel('Debug');
                
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                onAuthStateChanged(window.auth, (user) => {
                    updateAuthUI(user);
                    // 转  专转 专拽 专 住 转 专砖
                    listenForBlessings(); 
                });

            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                statusEl.textContent = '砖 专: 砖 转 Firebase.';
                statusEl.classList.remove('hidden', 'text-yellow-600', 'text-blue-600', 'text-green-600');
                statusEl.classList.add('text-red-600');
            }
        }
        
        // --- 驻拽爪转  转 爪转 ---
        let isInitialLoad = true;
        function listenForBlessings() {
            if (!window.db) return;

            const q = query(collection(window.db, window.collectionPath));

            onSnapshot(q, (snapshot) => {
                const blessingsContainer = document.getElementById('blessings-container');
                const galleryContainer = document.getElementById('gallery-container');
                const loadingMessage = document.getElementById('loading-message');
                
                if (isInitialLoad && loadingMessage) {
                    loadingMessage.remove();
                    isInitialLoad = false;
                }
                
                const dynamicElements = document.querySelectorAll('.dynamic-item');
                dynamicElements.forEach(el => el.remove());

                const allBlessings = [];
                snapshot.forEach((doc) => {
                    allBlessings.push({ id: doc.id, ...doc.data() });
                });
                
                allBlessings.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

                allBlessings.forEach(data => {
                    // 爪 转   砖转砖 专 砖 , 专转 转 砖  
                    const isCurrentUser = data.userId === window.currentUser?.uid;
                    const senderDisplay = data.senderName || (isCurrentUser && window.currentUser.email ? window.currentUser.email : '');
                    
                    if (data.blessingText) {
                        const newBlessing = document.createElement('blockquote');
                        newBlessing.classList.add('dynamic-item');
                        newBlessing.innerHTML = `
                            <p>"${data.blessingText}"</p>
                            <footer>- ${senderDisplay}</footer>
                        `;
                        blessingsContainer.appendChild(newBlessing);
                    }

                    if (data.base64Image) {
                        const newImageContainer = document.createElement('div');
                        newImageContainer.className = 'bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300 dynamic-item';
                        newImageContainer.innerHTML = `
                            <img src="${data.base64Image}" alt="转 -${data.senderName}" class="w-full h-48 object-cover">
                            <p class="p-3 text-center text-slate-600">转 砖 : ${senderDisplay}</p>
                        `;
                        galleryContainer.appendChild(newImageContainer);
                    }
                });
                
                blessingsContainer.scrollTop = blessingsContainer.scrollHeight;
            }, (error) => {
                console.error("Error fetching data:", error);
            });
        }
        
        // 驻拽爪 专转 拽抓 转 -Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = (error) => reject(error);
            });
        }

        // --- DOM CONTENT LOADED ---
        document.addEventListener('DOMContentLoaded', () => {
            // ... 住拽专驻 拽驻 ...
            const container = document.getElementById('confetti-container');
            const confettiCount = 100;
            const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6'];
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = `${Math.random() * 5}s`;
                const size = Math.random() * 5 + 5;
                confetti.style.width = `${size}px`;
                confetti.style.height = `${size}px`;
                container.appendChild(confetti);
            }
            
            // 驻注转 转 Firebase -Tone.js 专 注转 -DOM
            initFirebase();
            initializeSynth();
            
            // ** 转拽 注拽专: 爪转  驻转专 专 注转 -DOM **
            const authButton = document.getElementById('auth-button');
            //  砖转砖  专, 驻转专 驻转 转  (注 住驻 注砖 -updateAuthUI)
            if (authButton) {
                authButton.addEventListener('click', window.showAuthModal);
            }
            
            // 专转  驻住 
            document.getElementById('auth-form').addEventListener('submit', window.handleLoginRegister);
            
            // 拽 砖转 驻住 专
            const blessingForm = document.getElementById('blessing-form');
            const successMessage = document.getElementById('success-message');
            const submitButton = document.getElementById('submit-button');
            
            if (blessingForm) {
                blessingForm.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    
                    if (!window.db || !window.currentUser) {
                        const statusEl = document.getElementById('status-message');
                        statusEl.textContent = '砖: 注专转 转 注  . 住 砖 注 专注.';
                        statusEl.classList.remove('hidden', 'text-green-600');
                        statusEl.classList.add('text-red-600');
                        return;
                    }

                    submitButton.disabled = true;
                    submitButton.textContent = '...砖 专';
                    successMessage.classList.add('hidden');
                    
                    const senderName = document.getElementById('sender-name').value.trim();
                    const blessingText = document.getElementById('blessing-text').value.trim();
                    const imageFile = document.getElementById('image-upload').files[0];

                    if (!senderName || !blessingText) {
                        successMessage.classList.remove('hidden', 'text-green-600');
                        successMessage.classList.add('text-red-600');
                        successMessage.textContent = '  砖 专 驻 砖.';
                        submitButton.disabled = false;
                        submitButton.textContent = '住驻 转 专';
                        setTimeout(() => { successMessage.classList.add('hidden'); }, 3000);
                        return;
                    }

                    let base64Image = null;
                    if (imageFile) {
                        try {
                            base64Image = await fileToBase64(imageFile);
                        } catch (error) {
                            console.error("Error converting image to Base64:", error);
                        }
                    }

                    const blessingData = {
                        senderName: senderName,
                        blessingText: blessingText,
                        base64Image: base64Image,
                        timestamp: serverTimestamp(), 
                        userId: window.currentUser.uid
                    };

                    try {
                        await addDoc(collection(window.db, window.collectionPath), blessingData);
                        
                        if (synth) {
                            synth.triggerAttackRelease(["C5", "E5", "G5"], "8n");
                        }

                        successMessage.classList.remove('hidden', 'text-red-600');
                        successMessage.classList.add('text-green-600');
                        successMessage.textContent = '转! 专 住驻 爪, 转注...';
                        blessingForm.reset();
                    } catch (error) {
                        console.error("Error adding document:", error);
                        successMessage.classList.remove('hidden', 'text-green-600');
                        successMessage.classList.add('text-red-600');
                        successMessage.textContent = '砖 砖专转 专. 拽 转 拽住 (Console).';
                    } finally {
                        submitButton.disabled = false;
                        submitButton.textContent = '住驻 转 专';
                        setTimeout(() => { successMessage.classList.add('hidden'); }, 3000);
                    }
                });
            }
        });
    </script>

    <style>
        body {
            font-family: 'Assistant', sans-serif;
            overflow-x: hidden;
        }
        /* ... (注爪 拽驻 拽) ... */
        .confetti {
            position: fixed; width: 10px; height: 10px; background-color: #f00; opacity: 0.7; border-radius: 50%;
            animation: fall 5s linear infinite; top: -20px; z-index: 10;
        }
        @keyframes fall {
            to { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        blockquote {
            background-color: #f8fafc; border-right: 5px solid #0ea5e9; padding: 1rem 1.5rem; margin: 1.5rem 0;
            border-radius: 0 8px 8px 0; transition: all 0.3s ease-in-out;
        }
        blockquote:hover { box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        blockquote p { font-style: italic; }
        blockquote footer { text-align: left; margin-top: 0.5rem; font-weight: bold; color: #475569; }

        /* 注爪  */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6); z-index: 50;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: white; padding: 2rem; border-radius: 12px;
            max-width: 90%; width: 400px; position: relative;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="bg-cyan-50 text-slate-800">

    <div id="confetti-container"></div>

    <div class="container mx-auto p-4 md:p-8 max-w-4xl bg-white rounded-2xl shadow-2xl border-4 border-cyan-400">
        
        <!-- 转专转 专砖转 -->
        <header class="text-center my-8 md:my-12 p-6 rounded-xl bg-sky-100 shadow-xl">
            <h1 class="text-4xl md:text-6xl font-bold text-sky-700">  转 砖, ! </h1>
            <p class="text-2xl md:text-3xl mt-4 text-slate-700">   转 44!</p>
            
            <!-- 专 转专转 / 爪 砖转砖 -->
            <div class="mt-4 flex flex-col sm:flex-row justify-center items-center gap-2">
                <!-- 驻转专 专   onclick -HTML,  爪 -JS -->
                <button id="auth-button" class="bg-indigo-500 text-white text-sm font-semibold py-2 px-4 rounded-full hover:bg-indigo-600 transition-colors duration-300 shadow-md">
                    转专转 / 专砖
                </button>
                <p id="auth-status-text" class="text-sm text-yellow-600">...转 转</p>
            </div>

            <!-- 专 住住 专 -UID -->
            <div id="status-message" class="text-sm mt-2 font-semibold hidden"></div>
            <p id="user-id-display" class="text-xs text-slate-400 mt-2 hidden"> 砖转砖:</p>
        </header>

        <main>
            <!-- 拽注 专 砖转 - 注  转 砖 砖! -->
            <section class="bg-white rounded-lg shadow-lg p-6 md:p-8 mb-8 text-center">
                <h2 class="text-2xl font-bold mb-4 text-sky-800">专 砖转 </h2>
                <p class="text-lg leading-relaxed">
                     拽专, 专爪转   转   砖注. 转    砖砖, 转 转,  爪拽.
                       注专 转   砖注砖转 转 注砖 砖 砖 .   砖 专转 砖 专转, 砖专, 转 砖转  转.
                     ,
                </p>
                <p class="mt-4 font-bold text-xl">- 砖 -</p>
            </section>

            <!-- 专 专转 转 -->
            <h2 class="text-3xl font-bold text-center mb-6 text-sky-800"> 专转 专砖转!</h2>
            <section id="blessings-container" class="mb-8 p-4 bg-white rounded-lg shadow-inner max-h-96 overflow-y-auto">
                <p class="text-center text-slate-500 italic" id="loading-message">...注 专转 注转</p>
            </section>

            <!-- 专转 转转 -->
            <section class="mb-8">
                <h2 class="text-3xl font-bold text-center mb-6 text-sky-800">专转 专转 砖转驻转</h2>
                <div id="gallery-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- 转转 住转 拽转 -->
                    <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300">
                        <img src="https://placehold.co/600x400/3498db/ffffff?text=转+砖驻转转" alt="转 砖驻转转" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/3498db/ffffff?text=Loading+Error'">
                        <p class="p-3 text-center text-slate-600">转专 拽爪专 砖 转</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300">
                        <img src="https://placehold.co/600x400/e74c3c/ffffff?text=转+" alt="转 " class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e74c3c/ffffff?text=Loading+Error'">
                        <p class="p-3 text-center text-slate-600">注 专 转拽</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300">
                        <img src="https://placehold.co/600x400/2ecc71/ffffff?text=转+爪拽" alt="转 爪拽" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/2ecc71/ffffff?text=Loading+Error'">
                        <p class="p-3 text-center text-slate-600"> 转 爪拽</p>
                    </div>
                    <!-- 转转 砖转住驻 注  砖转砖 驻注  驻  -->
                </div>
            </section>

            <!-- 驻住 住驻转 专 转 -->
            <section class="bg-sky-50 rounded-lg shadow-lg p-6 md:p-8 text-center border-2 border-sky-200">
                <h2 class="text-2xl font-bold mb-4 text-sky-800">住驻 专 转 砖!</h2>
                <form id="blessing-form" class="flex flex-col gap-4 max-w-lg mx-auto text-right">
                    <input type="text" id="sender-name" placeholder="砖 砖 ()" class="w-full p-2 border border-slate-300 rounded-md" required>
                    <textarea id="blessing-text" placeholder="专 砖... ()" rows="4" class="w-full p-2 border border-slate-300 rounded-md" required></textarea>
                    <div>
                        <label for="image-upload" class="block mb-2 font-medium">专爪 住祝  转? (驻爪)</label>
                        <input type="file" id="image-upload" accept="image/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-100 file:text-sky-700 hover:file:bg-sky-200">
                        <p class="text-xs text-slate-500 mt-1">砖 :  转   爪专 砖专 住 转.</p>
                    </div>
                    <button type="submit" id="submit-button" class="bg-sky-600 text-white font-bold py-3 px-8 rounded-full hover:bg-sky-700 transition-colors duration-300 text-lg shadow-md w-full">
                        住驻 转 专
                    </button>
                </form>
                <p id="success-message" class="text-green-600 mt-4 font-bold hidden">转! 专 住驻 爪, 转注...</p>
            </section>
        </main>
        
        <footer class="text-center mt-12 mb-6">
            <p class="text-slate-500">  注  砖, 2025 &nbsp;</p>
        </footer>

    </div>
    
    <!--  转专转 / 专砖 (Login/Register Modal) -->
    <div id="auth-modal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <h3 class="text-2xl font-bold mb-6 text-indigo-700">转专转  专砖</h3>
            <!-- 驻住 砖转砖 驻拽爪 handleLoginRegister 砖砖驻 -window -->
            <form id="auth-form" class="flex flex-col gap-4" onsubmit="event.preventDefault(); window.handleLoginRegister(event);">
                <input type="email" id="auth-email" placeholder="''" class="w-full p-3 border border-slate-300 rounded-lg text-right" required>
                <input type="password" id="auth-password" placeholder="住住 (6 转 驻转)" class="w-full p-3 border border-slate-300 rounded-lg text-right" required minlength="6">
                
                <div class="flex justify-around mt-2">
                    <label class="inline-flex items-center">
                        <input type="radio" name="auth-action" value="login" checked class="form-radio text-indigo-600">
                        <span class="ml-2 mr-1">转专转</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="auth-action" value="register" class="form-radio text-indigo-600">
                        <span class="ml-2 mr-1">专砖</span>
                    </label>
                </div>

                <button type="submit" class="bg-indigo-600 text-white font-bold py-3 rounded-full hover:bg-indigo-700 transition-colors duration-300 text-lg shadow-md mt-4">
                    砖
                </button>
                <!-- 驻转专 拽专 驻拽爪 hideAuthModal 砖砖驻 -window -->
                <button type="button" onclick="window.hideAuthModal()" class="text-sm text-slate-500 hover:text-slate-700 mt-2">
                     专 专
                </button>
                <p id="modal-message" class="mt-3 font-semibold"></p>
            </form>
        </div>
    </div>
</body>
</html>
