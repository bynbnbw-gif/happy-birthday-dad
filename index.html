<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> 转 砖, !</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom Hebrew Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght=300;400;700&display=swap" rel="stylesheet">
    
    <!-- Firebase Imports for Firestore and Auth -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // 砖专 专拽 驻拽爪转 专转 转 驻 砖拽
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 砖 转 砖转 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        window.db = null;
        window.auth = null;
        window.currentUserId = null;
        window.collectionPath = `artifacts/${appId}/public/data/birthday_blessings`;

        let unsubscribeBlessings = null;
        let retryTimeoutId = null; 
        let isInitialLoad = true;
        
        // --- 拽转 转 转 砖拽 ( UI) ---
        
        async function initFirebase() {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = '...转 专 砖转驻';

            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase configuration is missing.");
                    statusEl.textContent = '砖: 专转 Firebase 住专转.';
                    return;
                }

                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                setLogLevel('Debug'); 
                
                // 转 砖拽 专拽注 -  砖 -Firestore
                await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(window.auth, async (user) => {
                        if (user) {
                            window.currentUserId = user.uid;
                            unsubscribe();
                            startBlessingsListenerWithRetry(statusEl); // 转 注转 转
                            resolve();
                            return;
                        }

                        //   砖转砖, 住 转专 爪专 转/拽
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(window.auth, initialAuthToken);
                            } else {
                                await signInAnonymously(window.auth);
                            }
                        } catch(e) {
                            console.error("Initial sign-in failed, the app will not function correctly:", e);
                        }
                        
                        unsubscribe();
                        resolve();
                    });
                });
                
                // 住专转  驻住  转 爪 砖拽
                document.getElementById('form-container').classList.remove('opacity-50', 'pointer-events-none');

            } catch (error) {
                console.error("Fatal error during Firebase initialization:", error);
                statusEl.textContent = '砖 专: 砖 转 Firebase.';
                statusEl.classList.add('text-red-600');
            }
        }

        // --- 拽转  注 转 (砖专 ) ---
        
        function cleanupListener() {
            if (unsubscribeBlessings) {
                unsubscribeBlessings();
                unsubscribeBlessings = null;
            }
            if (retryTimeoutId) {
                clearTimeout(retryTimeoutId);
                retryTimeoutId = null;
            }
        }
        
        function startBlessingsListenerWithRetry(statusEl) {
            if (!window.db) return;

            const MAX_RETRIES = 5;
            let currentRetry = 0;
            
            const attemptListen = () => {
                const q = query(collection(window.db, window.collectionPath));
                
                if (unsubscribeBlessings) {
                    unsubscribeBlessings();
                    unsubscribeBlessings = null;
                }

                unsubscribeBlessings = onSnapshot(q, (snapshot) => {
                    if (retryTimeoutId) {
                        clearTimeout(retryTimeoutId);
                        retryTimeoutId = null;
                    }
                    currentRetry = 0; 
                    
                    // 注 住住 爪
                    statusEl.textContent = '专 转 驻注. 专转 注转.';
                    statusEl.classList.remove('text-red-600', 'text-yellow-600');
                    statusEl.classList.add('text-green-600');

                    const blessingsContainer = document.getElementById('blessings-container');
                    const galleryContainer = document.getElementById('gallery-container');
                    const loadingMessage = document.getElementById('loading-message');
                    
                    if (isInitialLoad && loadingMessage) {
                        loadingMessage.remove();
                        isInitialLoad = false;
                    }
                    
                    const dynamicElements = document.querySelectorAll('.dynamic-item');
                    dynamicElements.forEach(el => el.remove());

                    const allBlessings = [];
                    snapshot.forEach((doc) => {
                        allBlessings.push({ id: doc.id, ...doc.data() });
                    });
                    
                    allBlessings.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

                    allBlessings.forEach(data => {
                        if (data.blessingText) {
                            const newBlessing = document.createElement('blockquote');
                            newBlessing.classList.add('dynamic-item', 'transition-opacity', 'duration-500');
                            newBlessing.innerHTML = `
                                <p>"${data.blessingText}"</p>
                                <footer>- ${data.senderName || ''}</footer>
                            `;
                            blessingsContainer.appendChild(newBlessing);
                        }

                        if (data.base64Image) {
                            const newImageContainer = document.createElement('div');
                            newImageContainer.className = 'bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300 dynamic-item';
                            newImageContainer.innerHTML = `
                                <img src="${data.base64Image}" alt="转 -${data.senderName}" class="w-full h-48 object-cover">
                                <p class="p-3 text-center text-slate-600">转 砖 : ${data.senderName || ''}</p>
                            `;
                            galleryContainer.appendChild(newImageContainer);
                        }
                    });
                    
                    blessingsContainer.scrollTop = blessingsContainer.scrollHeight;

                }, (error) => {
                    // 砖: 驻 砖转 专砖
                    if (error.code === 'permission-denied' && currentRetry < MAX_RETRIES) {
                        currentRetry++;
                        const delay = 2 ** currentRetry * 100 + Math.random() * 100;
                        
                        console.log(`Permission denied. Retrying in ${delay.toFixed(0)}ms (Attempt ${currentRetry}/${MAX_RETRIES}).`);
                        
                        if (unsubscribeBlessings) {
                            unsubscribeBlessings();
                            unsubscribeBlessings = null;
                        }

                        retryTimeoutId = setTimeout(attemptListen, delay);
                    } else {
                        // 砖 拽注 
                        console.error("Fatal Error fetching data:", error);
                        statusEl.textContent = '砖 拽注 注转 专转.';
                        statusEl.classList.add('text-red-600');
                        if (unsubscribeBlessings) {
                            unsubscribeBlessings();
                            unsubscribeBlessings = null;
                        }
                    }
                });
            };

            retryTimeoutId = setTimeout(attemptListen, 50); 
        }
        
        // --- 拽转 驻拽爪 (拽驻 驻住) ---

        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('confetti-container');
            const confettiCount = 100;
            const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6'];
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = `${Math.random() * 5}s`;
                const size = Math.random() * 5 + 5;
                confetti.style.width = `${size}px`;
                confetti.style.height = `${size}px`;
                container.appendChild(confetti);
            }
            
            initFirebase();
            
            //  转专 爪转 驻拽爪转 驻转专 转
            
            setupFormSubmission();
        });

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = (error) => reject(error);
            });
        }

        function setupFormSubmission() {
            const blessingForm = document.getElementById('blessing-form');
            const successMessage = document.getElementById('success-message');
            const submitButton = document.getElementById('submit-button');
            
            if (!blessingForm) return;

            blessingForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                
                if (!window.db) {
                    document.getElementById('success-message').textContent = '砖: 住 转  专.';
                    document.getElementById('success-message').classList.remove('hidden', 'text-green-600');
                    document.getElementById('success-message').classList.add('text-red-600');
                    return;
                }

                submitButton.disabled = true;
                submitButton.textContent = '...砖 专';
                successMessage.classList.add('hidden');
                
                const senderName = document.getElementById('sender-name').value.trim();
                const blessingText = document.getElementById('blessing-text').value.trim();
                const imageFile = document.getElementById('image-upload').files[0];

                if (!senderName || !blessingText) {
                    submitButton.disabled = false;
                    submitButton.textContent = '住驻 转 专';
                    document.getElementById('success-message').textContent = '  砖 专.';
                    document.getElementById('success-message').classList.remove('hidden', 'text-green-600');
                    document.getElementById('success-message').classList.add('text-red-600');
                    return;
                }

                let base64Image = null;
                if (imageFile) {
                    try {
                        base64Image = await fileToBase64(imageFile);
                    } catch (error) {
                        console.error("Error converting image to Base64:", error);
                    }
                }

                const blessingData = {
                    senderName: senderName,
                    blessingText: blessingText,
                    base64Image: base64Image,
                    timestamp: serverTimestamp(), 
                    userId: window.currentUserId || 'anonymous_unknown' // 砖砖 -UID  拽, 专转  驻
                };

                try {
                    await addDoc(collection(window.db, window.collectionPath), blessingData);
                    
                    successMessage.classList.remove('hidden', 'text-red-600');
                    successMessage.classList.add('text-green-600');
                    successMessage.textContent = '转! 专 住驻 爪, 转注...';
                    blessingForm.reset();
                } catch (error) {
                    console.error("Error adding document:", error);
                    successMessage.classList.remove('hidden', 'text-green-600');
                    successMessage.classList.add('text-red-600');
                    successMessage.textContent = '砖 砖专转 专. 住 砖 专 转专.';
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = '住驻 转 专';
                    setTimeout(() => { successMessage.classList.add('hidden'); }, 3000);
                }
            });
        }
    </script>

    <style>
        body {
            font-family: 'Assistant', sans-serif;
            overflow-x: hidden;
            direction: rtl; /* 转  砖 */
            text-align: right;
        }
        /* 注爪 拽驻 */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f00;
            opacity: 0.7;
            border-radius: 50%;
            animation: fall 5s linear infinite;
            top: -20px;
            z-index: 10;
        }
        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        /* 注爪 专转 (blockquote) */
        blockquote {
            background-color: #f8fafc;
            border-right: 5px solid #0ea5e9;
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
            transition: all 0.3s ease-in-out;
            text-align: right;
        }
        blockquote:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        blockquote p {
            font-style: italic;
        }
        blockquote footer {
            text-align: left; /* 砖 砖  爪 砖 */
            margin-top: 0.5rem;
            font-weight: bold;
            color: #475569;
        }
    </style>
</head>
<body class="bg-cyan-50 text-slate-800">

    <div id="confetti-container"></div>

    <div class="container mx-auto p-4 md:p-8 max-w-4xl bg-white rounded-2xl shadow-2xl border-4 border-cyan-400">
        
        <!-- 拽专转 转 住住 - 住专  -->

        <!-- 转专转 专砖转 -->
        <header class="text-center my-8 md:my-12 p-6 rounded-xl bg-sky-100 shadow-xl">
            <h1 class="text-4xl md:text-6xl font-bold text-sky-700">  转 砖, ! </h1>
            <p class="text-2xl md:text-3xl mt-4 text-slate-700">   转 44!</p>
            <!-- 专 住住 专 驻砖 -Firestore  -->
            <div id="status-message" class="text-sm mt-2 text-green-500 font-semibold">...转 专 砖转驻</div>
        </header>

        <main>
            <!-- 拽注 专 砖转 - 注  转 砖 砖! -->
            <section class="bg-white rounded-lg shadow-lg p-6 md:p-8 mb-8 text-center">
                <h2 class="text-2xl font-bold mb-4 text-sky-800">专 砖转 </h2>
                <p class="text-lg leading-relaxed">
                     拽专, 专爪转   转   砖注. 转    砖砖, 转 转,  爪拽.
                       注专 转   砖注砖转 转 注砖 砖 砖 .   砖 专转 砖 专转, 砖专, 转 砖转  转.
                     ,
                </p>
                <p class="mt-4 font-bold text-xl">- 砖-</p>
            </section>

            <!-- 专 专转 转 -->
            <h2 class="text-3xl font-bold text-center mb-6 text-sky-800"> 专转 专砖转!</h2>
            <section id="blessings-container" class="mb-8 p-4 bg-white rounded-lg shadow-inner max-h-96 overflow-y-auto">
                <p class="text-center text-slate-500 italic" id="loading-message">...注 专转 注转</p>
            </section>

            <!-- 专转 转转 -->
            <section class="mb-8">
                <h2 class="text-3xl font-bold text-center mb-6 text-sky-800">专转 专转 砖转驻转</h2>
                <div id="gallery-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- 转转 住转 拽转 -->
                    <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300">
                        <img src="https://placehold.co/600x400/3498db/ffffff?text=转+砖驻转转" alt="转 砖驻转转" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/3498db/ffffff?text=Loading+Error'">
                        <p class="p-3 text-center text-slate-600">转专 拽爪专 砖 转</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300">
                        <img src="https://placehold.co/600x400/e74c3c/ffffff?text=转+" alt="转 " class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e74c3c/ffffff?text=Loading+Error'">
                        <p class="p-3 text-center text-slate-600">注 专 转拽</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300">
                        <img src="https://placehold.co/600x400/2ecc71/ffffff?text=转+爪拽" alt="转 爪拽" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/2ecc71/ffffff?text=Loading+Error'">
                        <p class="p-3 text-center text-slate-600"> 转 爪拽</p>
                    </div>
                    <!-- 转转 砖转住驻 注  砖转砖 驻注  驻  -->
                </div>
            </section>

            <!-- 驻住 住驻转 专 转 -->
            <section id="form-container" class="bg-sky-50 rounded-lg shadow-lg p-6 md:p-8 text-center border-2 border-sky-200 transition-opacity duration-300">
                <h2 class="text-2xl font-bold mb-4 text-sky-800">住驻 专 转 砖!</h2>
                <form id="blessing-form" class="flex flex-col gap-4 max-w-lg mx-auto text-right">
                    <input type="text" id="sender-name" placeholder="砖 砖 ()" class="w-full p-2 border border-slate-300 rounded-md" required>
                    <textarea id="blessing-text" placeholder="专 砖... ()" rows="4" class="w-full p-2 border border-slate-300 rounded-md" required></textarea>
                    <div>
                        <label for="image-upload" class="block mb-2 font-medium">专爪 住祝  转? (驻爪)</label>
                        <input type="file" id="image-upload" accept="image/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-100 file:text-sky-700 hover:file:bg-sky-200">
                        <p class="text-xs text-slate-500 mt-1">砖 :  转   爪专 砖专 住 转.</p>
                    </div>
                    <button type="submit" id="submit-button" class="bg-sky-600 text-white font-bold py-3 px-8 rounded-full hover:bg-sky-700 transition-colors duration-300 text-lg shadow-md w-full">
                        住驻 转 专
                    </button>
                </form>
                <p id="success-message" class="text-green-600 mt-4 font-bold hidden">转! 专 住驻 爪, 转注...</p>
            </section>
        </main>
        
        <footer class="text-center mt-12 mb-6">
            <p class="text-slate-500">  注  砖, 2025</p>
        </footer>

    </div>
</body>
</html>
