<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מכונת החלומות ודף הברכות של ינאי</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <!-- Custom Styles for Animation -->
    <style>
        .animate-ping-once {
            animation: ping 0.5s cubic-bezier(0, 0, 0.2, 1) 1;
        }
        @keyframes ping {
            75%, 100% {
                transform: scale(2);
                opacity: 0;
            }
        }
        .reply-section {
            transition: max-height 0.3s ease-in-out;
            overflow: hidden;
        }
        /* Ensure Hebrew font works well */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, orderBy, limit, addDoc, updateDoc, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL FIREBASE VARIABLES & SETUP ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = 'loading';
        let isAuthReady = false;

        // Global variable to hold all greetings data for sorting/AI Summary
        window.allGreetings = []; 

        // Functions exposed to the global scope
        window.initializeFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. Cannot initialize Firestore.");
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                window.db = db; // Expose for other functions

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated user ID:", userId);
                    } else {
                        // Sign in with custom token if available, otherwise anonymously
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                            userId = auth.currentUser.uid;
                        }
                    }
                    isAuthReady = true;
                    window.userId = userId; // Expose for other functions
                    document.getElementById('user-id-display').innerText = `מזהה משתמש: ${userId}`;
                    window.loadGreetings(); // Start loading data after auth
                });
            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
            }
        };

        // Function to get the correct collection path (private for this app's greetings)
        window.getGreetingsCollectionRef = () => {
            return collection(db, `artifacts/${appId}/users/${userId}/yanai_greetings`);
        };
        
        // --- DATA LOADING (GREETINGS) ---
        window.loadGreetings = () => {
            if (!isAuthReady || !db) return;

            // Using simple query for real-time listener (data will be sorted/filtered in JS)
            const q = query(window.getGreetingsCollectionRef(), orderBy("timestamp", "desc"));
            
            onSnapshot(q, (querySnapshot) => {
                const greetings = [];
                querySnapshot.forEach((doc) => {
                    greetings.push({ id: doc.id, ...doc.data() });
                });
                window.allGreetings = greetings; // Save raw data
                window.sortAndRender(); // Sort and render based on current criteria
            }, (error) => {
                console.error("Error listening to greetings:", error);
                document.getElementById('greetings-list').innerHTML = `<p class="text-red-500">שגיאה בטעינת הברכות: ${error.message}</p>`;
            });
        };

        // Call initialization on window load
        window.onload = window.initializeFirebase;

        // Expose updateDoc and doc for toggleLike function
        window.updateDoc = updateDoc;
        window.doc = doc;
        window.arrayUnion = arrayUnion; // Expose for replies
    </script>
</head>
<body class="bg-gray-50 text-gray-900 font-['Inter'] antialiased min-h-screen p-4 sm:p-8" onload="window.initializeFirebase()">

    <!-- Main Container -->
    <div class="max-w-6xl mx-auto space-y-12">
        
        <!-- Header Section -->
        <header class="text-center p-6 bg-yellow-400 rounded-2xl shadow-xl border-4 border-yellow-500">
            <h1 class="text-4xl sm:text-6xl font-extrabold text-white drop-shadow-lg">🎉 יום הולדת 44 לינאי, המלך! 🎉</h1>
            <p class="mt-2 text-xl font-medium text-gray-800">דף ברכות אינטראקטיבי ומשוגע במיוחד</p>
            <div id="user-id-display" class="text-xs mt-2 text-gray-700 break-all" style="direction: ltr;">מזהה משתמש: טוען...</div>
        </header>

        <!-- Dynamic Content Sections Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- 1. מכונת החלומות: הפיכת זיכרון לתמונה (Image Generation) -->
            <div id="dream-machine" class="p-6 bg-white rounded-xl shadow-2xl border-t-8 border-indigo-500 space-y-4">
                <h2 class="text-3xl font-bold text-indigo-700 flex items-center gap-2">✨ מכונת החלומות: זיכרון הופך לתמונה</h2>
                <p class="text-gray-600">כתוב זיכרון יפה, רגע מצחיק או חלום עתידי שאתה רוצה שאבא ינצור. **תמונה ייחודית תיווצר עבורך.**</p>
                <textarea id="dream-prompt" rows="3" class="w-full p-3 border-2 border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 resize-none" placeholder="לדוגמה: ינאי והילדים משחקים כדורגל בשקיעה, סביבם פרחים סגולים." dir="rtl"></textarea>
                <button onclick="generateDreamImage()" id="dream-button" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold text-lg hover:bg-indigo-700 transition duration-300 shadow-md disabled:bg-indigo-400">צור תמונת חלום</button>
                <div id="dream-output" class="mt-4 text-center min-h-40 flex items-center justify-center bg-gray-100 rounded-lg p-2 relative">
                    <p class="text-gray-500">התמונה שנוצרה תופיע כאן.</p>
                </div>
            </div>

            <!-- 2. מכונת הזמן: נבואה ליום הולדת 60 (Text Generation) -->
            <div id="time-machine" class="p-6 bg-white rounded-xl shadow-2xl border-t-8 border-purple-500 space-y-4">
                <h2 class="text-3xl font-bold text-purple-700 flex items-center gap-2">🕰️ מכונת הזמן: הנבואה ל-60!</h2>
                <p class="text-gray-600">לחץ כדי לקבל הצצה מרגשת לעתיד: מה צפוי לינאי ביום הולדתו ה-60?</p>
                <button onclick="generateProphecy()" id="prophecy-button" class="w-full bg-purple-600 text-white py-3 rounded-xl font-bold text-lg hover:bg-purple-700 transition duration-300 shadow-md disabled:bg-purple-400">חשוף את הנבואה</button>
                <div id="prophecy-output" class="mt-4 p-4 border-2 border-purple-300 bg-purple-50 rounded-lg min-h-20 flex items-center justify-center">
                    <p class="text-purple-700 font-medium">כאן תופיע הנבואה המרגשת...</p>
                </div>
            </div>
            
            <!-- 3. שיר אישי לינאי (Text Generation) -->
            <div id="song-generator" class="p-6 bg-white rounded-xl shadow-2xl border-t-8 border-pink-500 space-y-4">
                <h2 class="text-3xl font-bold text-pink-700 flex items-center gap-2">🎵 שיר אישי לינאי: בלחיצת כפתור</h2>
                <p class="text-gray-600">כתוב מילה אחת או משפט קצר (כגון: "אוהב לטייל") כדי לקבל שיר מלא.</p>
                <input type="text" id="song-prompt" class="w-full p-3 border-2 border-pink-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 transition duration-150" placeholder="לדוגמה: השף של הבית" dir="rtl" />
                <button onclick="generateSong()" id="song-button" class="w-full bg-pink-600 text-white py-3 rounded-xl font-bold text-lg hover:bg-pink-700 transition duration-300 shadow-md disabled:bg-pink-400">צור את השיר</button>
                <div id="song-output" class="mt-4 p-4 border-2 border-pink-300 bg-pink-50 rounded-lg whitespace-pre-line text-pink-700 min-h-20 flex items-center justify-center">
                    <p class="text-pink-700 font-medium">כאן יופיע השיר המיוחד...</p>
                </div>
            </div>

            <!-- 4. עובדות על גיל 44 (Facts) -->
            <div id="facts-section" class="p-6 bg-white rounded-xl shadow-2xl border-t-8 border-green-500 space-y-4">
                <h2 class="text-3xl font-bold text-green-700 flex items-center gap-2">🔢 עובדות על גיל 44 ושנת 1981</h2>
                <p class="text-gray-600">כל לחיצה חושפת עובדה מפתיעה ומפורטת על גיל 44 או על שנת 1981 (מידע מעודכן).</p>
                <button onclick="showNextFact()" id="fact-button" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold text-lg hover:bg-green-700 transition duration-300 shadow-md disabled:bg-green-400">עובדה הבאה!</button>
                <div id="fact-output" class="mt-4 p-4 border-2 border-green-300 bg-green-50 rounded-lg min-h-20 flex items-center justify-center">
                    <p class="text-green-700 font-medium">לחץ על הכפתור כדי לגלות עובדה ראשונה...</p>
                </div>
            </div>
            
            <!-- 5. סיכום AI חכם ומונה איחולים נפוצים -->
            <div id="ai-summary-section" class="p-6 bg-white rounded-xl shadow-2xl border-t-8 border-cyan-500 space-y-4 lg:col-span-2">
                <h2 class="text-3xl font-bold text-cyan-700 flex items-center gap-2">🧠 ניתוח וסיכום AI + איחולים מובילים</h2>
                
                <div id="top-wishes" class="flex flex-wrap gap-2 text-center min-h-12 items-center justify-center">
                    <p class="text-gray-500 text-lg">טוען נתונים...</p>
                </div>
                
                <button onclick="generateGreetingsSummary()" id="summary-button" class="w-full bg-cyan-600 text-white py-3 rounded-xl font-bold text-lg hover:bg-cyan-700 transition duration-300 shadow-md disabled:bg-cyan-400">הפק סיכום ברכות חכם</button>
                <div id="summary-output" class="mt-4 p-4 border-2 border-cyan-300 bg-cyan-50 rounded-lg min-h-20 flex items-center justify-center">
                    <p class="text-cyan-700 font-medium">כאן יופיע סיכום הברכות לאחר הלחיצה.</p>
                </div>
            </div>
        </div>

        <!-- 6. הוספת ברכה אישית (Greeting Submission & Display) -->
        <div id="greetings-section" class="p-6 bg-white rounded-xl shadow-2xl border-t-8 border-red-500">
            <h2 class="text-3xl font-bold text-red-700 mb-6">💌 הוסף ברכה אישית לינאי</h2>
            
            <form id="greeting-form" class="space-y-4 p-4 border border-red-200 rounded-lg bg-red-50">
                <input type="text" id="greeter-name" required class="w-full p-3 border-2 border-red-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="שם המברך (חובה)" dir="rtl" />
                <textarea id="greeting-text" rows="4" required class="w-full p-3 border-2 border-red-300 rounded-lg focus:ring-red-500 focus:border-red-500 resize-none" placeholder="כתוב את הברכה שלך כאן..." dir="rtl"></textarea>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- קבצים (עד 3) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">צרף תמונות/קבצים (עד 3)</label>
                        <input type="file" id="greeting-files" multiple accept="image/*,video/*,audio/*" class="mt-1 w-full p-2 border border-red-300 rounded-lg" onchange="handleFileSelection(this)" />
                    </div>
                    <!-- הקלטה קולית -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">הקלטת קול (עד 30 שניות)</label>
                        <div class="mt-1 flex gap-2">
                            <button type="button" id="record-button" class="flex-1 p-2 bg-red-400 text-white rounded-lg hover:bg-red-500 transition duration-150">התחל הקלטה</button>
                            <button type="button" id="stop-button" disabled class="flex-1 p-2 bg-gray-400 text-white rounded-lg disabled:opacity-50">סיים הקלטה</button>
                        </div>
                        <audio id="audio-preview" controls class="mt-2 w-full hidden"></audio>
                    </div>
                </div>

                <div id="file-count" class="text-sm text-red-600">0 קבצים ו-0 הקלטות מוכנים לשליחה.</div>

                <button type="submit" id="submit-greeting" class="w-full bg-red-600 text-white py-3 rounded-xl font-bold text-lg hover:bg-red-700 transition duration-300 shadow-md disabled:bg-red-400">
                    שלח את הברכה המיוחדת
                </button>
            </form>

            <h3 class="text-2xl font-bold text-red-700 mt-10 mb-4 border-b pb-2">כל הברכות שנשלחו:</h3>
            
            <!-- NEW: Sorting and Filtering Controls -->
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3 p-3 bg-gray-100 rounded-lg">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-semibold text-gray-700">מיין לפי:</span>
                    <button onclick="setSortCriteria('newest')" id="sort-newest" class="text-xs px-3 py-1 bg-red-600 text-white rounded-full transition duration-150">הכי חדש</button>
                    <button onclick="setSortCriteria('likes')" id="sort-likes" class="text-xs px-3 py-1 bg-red-200 text-red-800 rounded-full hover:bg-red-300 transition duration-150">הכי אהוב</button>
                </div>

                <div class="flex items-center gap-2">
                    <span class="text-sm font-semibold text-gray-700">סנן טון:</span>
                    <select id="tone-filter" onchange="setFilterTone(this.value)" class="text-sm border border-gray-300 rounded-lg p-1">
                        <option value="">הצג הכל</option>
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
            </div>

            <div id="greetings-list" class="space-y-6">
                <p class="text-gray-500 text-center">טוען ברכות מ-Firestore...</p>
            </div>
        </div>
        
    </div>

    <!-- Attribution (Added here as requested by user) -->
    <footer class="mt-12 text-center text-sm text-gray-500 pb-4">
        <p>נבנה על ידי יאיר ואבישי</p>
    </footer>

    <!-- Global Modal/Success Message -->
    <div id="global-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center space-y-4 transform transition-all duration-300 scale-100">
            <h3 id="modal-title" class="text-2xl font-bold text-red-600"></h3>
            <p id="modal-message" class="text-gray-700"></p>
            <button onclick="closeModal()" class="w-full bg-red-500 text-white py-2 rounded-lg font-semibold hover:bg-red-600 transition duration-300">סגור</button>
        </div>
    </div>

    <!-- JavaScript & API Logic -->
    <script>
        // --- Firebase Globals (Set after initialization in type="module") ---
        // window.db, window.userId, window.getGreetingsCollectionRef, window.loadGreetings, window.allGreetings
        
        // --- API Keys and Endpoints ---
        const apiKey = ""; 
        const TEXT_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const IMAGE_MODEL_PREDICT = 'imagen-3.0-generate-002:predict';

        // --- State Variables ---
        let factIndex = 0; // To cycle between 1981 and 44
        
        let recorder = null;
        let audioChunks = [];
        let recordedBlob = null;
        let isRecording = false;

        let currentSortCriteria = 'newest'; // 'newest' or 'likes'
        let currentFilterTone = ''; // Tone string or empty for all

        // --- Helpers ---
        function setButtonLoading(buttonId, isLoading, defaultText) {
            const button = document.getElementById(buttonId);
            const spinner = `<span class="animate-spin inline-block mr-2 border-r-2 border-white rounded-full h-5 w-5"></span>`;
            button.disabled = isLoading;
            button.innerHTML = isLoading ? `${spinner} טוען...` : defaultText;
        }

        async function fetchAI(apiUrl, payload) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API call failed: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error("Fetch failed:", error);
                throw new Error("שגיאה בחיבור לשרת הבינה המלאכותית.");
            }
        }
        
        // --- MODAL / SUCCESS MESSAGE ---
        function showModal(title, message) {
            const modal = document.getElementById('global-modal');
            if (!modal) return;
            
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            
            const titleElement = document.getElementById('modal-title');
            const closeButton = modal.querySelector('button');
            
            // Set colors based on success/error
            if (title === 'הצלחה!' || title.includes('נוצרה') || title.includes('הושלם') || title.includes('נחשפה')) {
                titleElement.classList.replace('text-red-600', 'text-green-600');
                closeButton.classList.replace('bg-red-500', 'bg-green-500');
                closeButton.classList.replace('hover:bg-red-600', 'hover:bg-green-600');
            } else {
                titleElement.classList.replace('text-green-600', 'text-red-600');
                closeButton.classList.replace('bg-green-500', 'bg-red-500');
                closeButton.classList.replace('hover:bg-green-600', 'hover:bg-red-600');
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            if (title === 'הצלחה!' || title.includes('נוצרה') || title.includes('הושלם') || title.includes('נחשפה')) {
                setTimeout(closeModal, 4000);
            }
        }

        function closeModal() {
            const modal = document.getElementById('global-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }
        window.closeModal = closeModal; // Expose to HTML button

        // --- SORTING AND FILTERING LOGIC (NEW) ---
        function setSortCriteria(criteria) {
            currentSortCriteria = criteria;
            document.getElementById('sort-newest').classList.toggle('bg-red-600', criteria === 'newest');
            document.getElementById('sort-newest').classList.toggle('text-white', criteria === 'newest');
            document.getElementById('sort-newest').classList.toggle('bg-red-200', criteria !== 'newest');
            document.getElementById('sort-newest').classList.toggle('text-red-800', criteria !== 'newest');
            
            document.getElementById('sort-likes').classList.toggle('bg-red-600', criteria === 'likes');
            document.getElementById('sort-likes').classList.toggle('text-white', criteria === 'likes');
            document.getElementById('sort-likes').classList.toggle('bg-red-200', criteria !== 'likes');
            document.getElementById('sort-likes').classList.toggle('text-red-800', criteria !== 'likes');

            sortAndRender();
        }
        window.setSortCriteria = setSortCriteria; // Expose

        function setFilterTone(tone) {
            currentFilterTone = tone;
            sortAndRender();
        }
        window.setFilterTone = setFilterTone; // Expose
        
        function sortAndRender() {
            let sortedGreetings = [...window.allGreetings];
            
            // 1. Filter
            if (currentFilterTone) {
                sortedGreetings = sortedGreetings.filter(g => g.tone === currentFilterTone);
            }

            // 2. Sort
            if (currentSortCriteria === 'likes') {
                sortedGreetings.sort((a, b) => (b.likesCount || 0) - (a.likesCount || 0));
            } else { // 'newest'
                sortedGreetings.sort((a, b) => {
                    const timeA = a.timestamp?.toMillis ? a.timestamp.toMillis() : 0;
                    const timeB = b.timestamp?.toMillis ? b.timestamp.toMillis() : 0;
                    return timeB - timeA;
                });
            }

            // 3. Render
            window.renderGreetings(sortedGreetings);
            
            // 4. Update filters and wish counter (as data changes)
            updateToneFilterOptions();
            updateTopWishes();
        }
        window.sortAndRender = sortAndRender; // Expose


        // --- TONE ANALYSIS LOGIC ---
        async function analyzeTone(text) {
            const systemPrompt = "אתה מנתח רגשות מקצועי. נתח את טון הברכה הקצרה הבאה וספק מילה אחת או שתי מילים בלבד המייצגות את הטון המרכזי (לדוגמה: אוהב, מצחיק, מרגש, רשמי, מפרגן). אנא השב רק במילים אלו בעברית, ללא הסברים. הטקסט: " + text;
            const userQuery = "נתח את הטון של ברכה זו.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${apiKey}`;
            
            try {
                const result = await fetchAI(apiUrl, payload);
                let tone = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "לא נותח";
                return tone.replace(/["'״]/g, '').split('\n')[0].trim();
            } catch (e) {
                console.error("Tone analysis failed:", e);
                return "שגיאת ניתוח";
            }
        }
        
        // --- TOP WISHES COUNTER LOGIC (NEW) ---
        async function getTopWishesFromAI(greetingTexts) {
            const systemPrompt = "אתה מומחה לכריית טקסט. סרוק את רשימת הברכות והפק רשימת JSON של עד 5 האיחולים או המילים המרכזיות ביותר (שחוזרות על עצמן או שהן הנושא המרכזי) שאנשים איחלו לינאי. השב רק במערך JSON. דוגמה: [\"בריאות\", \"אושר\", \"טיולים\"]";
            const userQuery = "נתח את הטקסטים הבאים ומצא את 5 האיחולים המובילים: " + greetingTexts.join('; ').substring(0, 3000);
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: { "type": "STRING" }
                    }
                }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${apiKey}`;

            try {
                const result = await fetchAI(apiUrl, payload);
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                return JSON.parse(jsonText);
            } catch (e) {
                console.error("Top wishes analysis failed:", e);
                return [];
            }
        }

        async function updateTopWishes() {
            const outputElement = document.getElementById('top-wishes');
            if (window.allGreetings.length === 0) {
                outputElement.innerHTML = `<p class="text-gray-500 text-lg">אין מספיק נתונים לניתוח איחולים.</p>`;
                return;
            }
            
            outputElement.innerHTML = `<span class="animate-pulse text-cyan-600">טוען איחולים מובילים...</span>`;

            const greetingTexts = window.allGreetings.map(g => g.text);
            
            try {
                const topWishes = await getTopWishesFromAI(greetingTexts);
                if (topWishes.length > 0) {
                    const html = topWishes.map(wish => 
                        `<span class="px-3 py-1 bg-cyan-100 text-cyan-800 text-base font-bold rounded-full shadow-sm">${wish} ✨</span>`
                    ).join('');
                    outputElement.innerHTML = html;
                } else {
                    outputElement.innerHTML = `<p class="text-gray-500 text-lg">לא נמצאו איחולים בולטים.</p>`;
                }
            } catch (e) {
                outputElement.innerHTML = `<p class="text-red-500">שגיאה בניתוח AI.</p>`;
            }
        }

        // --- FILTER OPTION UPDATER (NEW) ---
        function updateToneFilterOptions() {
            const toneFilterSelect = document.getElementById('tone-filter'); 
            if (!toneFilterSelect) return; 

            const tones = [...new Set(window.allGreetings.map(g => g.tone).filter(t => t && t !== 'לא נותח' && t !== 'שגיאת ניתוח'))];
            
            toneFilterSelect.innerHTML = '<option value="">הצג הכל</option>';
            tones.forEach(tone => {
                const option = document.createElement('option');
                option.value = tone;
                option.innerText = tone;
                toneFilterSelect.appendChild(option);
            });
            toneFilterSelect.value = currentFilterTone; // Restore current filter
        }

        // --- AI REPLY GENERATION LOGIC (NEW FEATURE) ---
        window.generateAIReply = async (greetingId, senderName, greetingText) => {
            const input = document.getElementById(`reply-input-${greetingId}`);
            const aiButton = document.getElementById(`ai-reply-button-${greetingId}`);

            // 1. Ensure the reply box is open
            window.toggleReplyBox(greetingId, true); 

            aiButton.disabled = true;
            aiButton.innerHTML = '🤖 מנסח...';

            // The system prompt defines the persona and task.
            const systemPrompt = `אתה פועל כ"ינאי" (Yanai), איש יום הולדת שקיבל ברכה. מטרתך היא להשיב בצורה חמה, אישית, ומחמיאה לברכה הבאה. הברכה נשלחה על ידי ${senderName}. הגב במשפט או שניים קצרים, תודה לכותב/ת, ואזם לשמירה על טון חברי ומעט הומוריסטי אם מתאים. השב רק בטקסט התגובה, ללא שם השולח או כותרות.`;
            const userQuery = `הגב לברכה זו: "${greetingText}"`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${apiKey}`;

            try {
                const result = await fetchAI(apiUrl, payload);
                const replyText = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "לא הצלחתי לחשוב על תגובה כרגע. סליחה!";
                
                input.value = replyText;

            } catch (e) {
                console.error("AI Reply generation failed:", e);
                showModal('שגיאת AI', `שגיאה ביצירת תגובת AI: ${e.message}`);
            } finally {
                aiButton.disabled = false;
                aiButton.innerHTML = '🤖 צור תגובת AI';
            }
        }


        // --- AI GENERATION LOGIC (UPDATED FOR LENGTH/QUALITY) ---

        // 1. מכונת החלומות: יצירת תמונה (UPDATED PROMPT STRUCTURE)
        async function generateDreamImage() {
            const prompt = document.getElementById('dream-prompt').value.trim();
            if (!prompt) {
                showModal('שגיאה', 'אנא כתוב זיכרון או חלום כדי ליצור תמונה.');
                return;
            }
            setButtonLoading('dream-button', true, 'צור תמונת חלום');
            const outputElement = document.getElementById('dream-output');
            outputElement.innerHTML = `<div class="text-center text-indigo-700 p-4"><span class="animate-spin inline-block h-8 w-8 border-4 border-indigo-500 border-t-transparent rounded-full mb-3"></span><p class="font-bold">מכונת החלומות פועלת, ממירה זיכרון לתמונה...</p></div>`;

            // CRITICAL UPDATE: Focusing the base prompt on the user's memory content.
            // This ensures the AI model prioritizes the memory description.
            const fullPrompt = `A lively, emotional, and high-quality cinematic photo of a celebratory Israeli event. The central figures are Yanai and his family, capturing a moment of warm nostalgia and happiness. The specific memory to focus on is: "${prompt}".`;
            
            const payload = { 
                instances: [{ prompt: fullPrompt }], 
                parameters: { "sampleCount": 1 } 
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGE_MODEL_PREDICT}?key=${apiKey}`;

            try {
                const result = await fetchAI(apiUrl, payload);
                const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;

                if (base64Data) {
                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    outputElement.innerHTML = `
                        <img src="${imageUrl}" alt="${prompt}" class="w-full h-auto rounded-lg shadow-xl border-4 border-indigo-400 object-cover max-h-96">
                        <p class="text-xs text-gray-500 mt-2">התמונה נוצרה על בסיס: "${prompt}"</p>
                    `;
                    showModal('הצלחה!', 'תמונת החלום נוצרה בהצלחה!');
                } else {
                    throw new Error("לא התקבלה תמונה מה-AI.");
                }
            } catch (e) {
                outputElement.innerHTML = `<p class="text-red-500 font-bold">שגיאה ביצירת תמונה. אנא נסה שנית.</p>`;
                showModal('שגיאה', `שגיאה ביצירת תמונת החלום: ${e.message}`);
            } finally {
                setButtonLoading('dream-button', false, 'צור תמונת חלום');
            }
        }
        window.generateDreamImage = generateDreamImage;


        // 2. מכונת הזמן: נבואה ליום הולדת 60
        async function generateProphecy() {
            setButtonLoading('prophecy-button', true, 'חשוף את הנבואה');
            const outputElement = document.getElementById('prophecy-output');
            outputElement.innerHTML = `<div class="text-center text-purple-700"><span class="animate-spin inline-block h-6 w-6 border-2 border-purple-500 border-t-transparent rounded-full mb-2"></span><p class="font-bold">מכונת הזמן מחשבת את העתיד...</p></div>`;

            const userQuery = "כתוב נבואה חמה, מרגשת, ומפורטת (כ-100 מילים) על מה ינאי, שהיום חוגג 44, ישיג ואיך יראה ביום הולדתו ה-60. הנבואה צריכה לכלול 3 הישגים מרכזיים (מקצועי, משפחתי, רוחני/תחביבים). השב בטקסט מעוצב בפסקאות קצרות.";
            const systemPrompt = "אתה נביא מרגש ומעורר השראה. כתוב נבואה חיובית ומלאת תקווה בעברית ליום הולדתו ה-60 של ינאי. השב רק בטקסט הנבואה המנוסח היטב.";

            const payload = { 
                contents: [{ parts: [{ text: userQuery }] }], 
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${apiKey}`;

            try {
                const result = await fetchAI(apiUrl, payload);
                const prophecyText = result.candidates?.[0]?.content?.parts?.[0]?.text || "לא ניתן היה ליצור נבואה. נסה שוב.";
                outputElement.innerHTML = `<p class="text-purple-800 font-bold whitespace-pre-line">${prophecyText}</p>`;
                showModal('הצלחה!', 'נבואת יום ההולדת 60 נחשפה!');
            } catch (e) {
                outputElement.innerHTML = `<p class="text-red-500 font-bold">שגיאה במכונת הזמן. אנא נסה שנית.</p>`;
                showModal('שגיאה', `שגיאה במכונת הזמן: ${e.message}`);
            } finally {
                setButtonLoading('prophecy-button', false, 'חשוף את הנבואה');
            }
        }
        window.generateProphecy = generateProphecy;


        // 3. שיר אישי לינאי
        async function generateSong() {
            const prompt = document.getElementById('song-prompt').value.trim() || "אוהב את המשפחה";
            setButtonLoading('song-button', true, 'צור את השיר');
            const outputElement = document.getElementById('song-output');
            outputElement.innerHTML = `<div class="text-center text-pink-700"><span class="animate-spin inline-block h-6 w-6 border-2 border-pink-500 border-t-transparent rounded-full mb-2"></span><p class="font-bold">כותב השירים מנסח את הלהיט הבא...</p></div>`;

            const userQuery = `כתוב שיר/פזמון מלא (4 בתים מחורזים, כ-80 מילים) לכבוד יום ההולדת ה-44 של ינאי. השתמש בנושא הבא כהשראה: "${prompt}". הטון צריך להיות שמח ומפרגן.`;
            const systemPrompt = "אתה משורר כישרוני. כתוב שיר חגיגי ומחורז בעברית לכבוד יום הולדת. השב רק בטקסט השיר המעוצב בפסקאות קצרות.";

            const payload = { 
                contents: [{ parts: [{ text: userQuery }] }], 
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${apiKey}`;

            try {
                const result = await fetchAI(apiUrl, payload);
                const songText = result.candidates?.[0]?.content?.parts?.[0]?.text || "לא ניתן היה ליצור שיר. נסה שוב.";
                outputElement.innerHTML = `<p class="text-pink-800 font-bold whitespace-pre-line">${songText}</p>`;
                showModal('הצלחה!', 'השיר האישי נוצר!');
            } catch (e) {
                outputElement.innerHTML = `<p class="text-red-500 font-bold">שגיאה ביצירת שיר. אנא נסה שנית.</p>`;
                showModal('שגיאה', `שגיאה בכותב השירים: ${e.message}`);
            } finally {
                setButtonLoading('song-button', false, 'צור את השיר');
            }
        }
        window.generateSong = generateSong;

        
        // 4. עובדות על גיל 44 ושנת 1981 (עם Google Search)
        async function showNextFact() {
            const outputElement = document.getElementById('fact-output');
            setButtonLoading('fact-button', true, 'טוען עובדה...');
            outputElement.innerHTML = `<div class="text-center text-green-700"><span class="animate-spin inline-block h-6 w-6 border-2 border-green-500 border-t-transparent rounded-full mb-2"></span><p class="font-bold">מחפש עובדה מדהימה (מידע עדכני)...</p></div>`;

            const is1981 = factIndex++ % 2 === 0;
            const factType = is1981 ? "על שנת 1981" : "על גיל 44";
            const searchTopic = is1981 ? "מעניינת על שנת 1981" : "על גיל 44 או המספר 44";

            const userQuery = `מצא עובדה אחת מרתקת ומפורטת (עד 50 מילים) על ${searchTopic} והסבר אותה בהרחבה קצרה.`;
            const systemPrompt = `אתה היסטוריון חובב טריוויה. ספק עובדה אחת מרתקת ומפורטת בעברית על הנושא המבוקש. השב רק בטקסט העובדה המנוסח היטב. השתמש בכלי החיפוש.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: [{ "google_search": {} }],
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${apiKey}`;

            try {
                const result = await fetchAI(apiUrl, payload);
                const factText = result.candidates?.[0]?.content?.parts?.[0]?.text || "לא נמצאה עובדה מרתקת. נסה שוב.";
                outputElement.innerHTML = `<p class="text-green-800 font-bold whitespace-pre-line">${factText}</p>`;
            } catch (e) {
                outputElement.innerHTML = `<p class="text-red-500 font-bold">שגיאה במציאת עובדה. אנא נסה שנית.</p>`;
            } finally {
                setButtonLoading('fact-button', false, 'עובדה הבאה!');
            }
        }
        window.showNextFact = showNextFact;

        
        // 5. סיכום הברכות הכללי
        async function generateGreetingsSummary() {
            if (window.allGreetings.length === 0) {
                document.getElementById('summary-output').innerHTML = `<p class="text-red-500 font-bold">לא ניתן ליצור סיכום, עדיין אין ברכות!</p>`;
                return;
            }
            setButtonLoading('summary-button', true, 'הפק סיכום ברכות חכם');
            const outputElement = document.getElementById('summary-output');
            outputElement.innerHTML = `<div class="text-center text-cyan-700"><span class="animate-spin inline-block h-8 w-8 border-4 border-cyan-500 border-t-transparent rounded-full mb-3"></span><p class="font-bold">הבינה המלאכותית מנתחת את רגשות האורחים...</p></div>`;
            const greetingData = window.allGreetings.map(g => 
                `מאת: ${g.greeterName}, טון: ${g.tone || 'לא נותח'}, טקסט: "${g.text.substring(0, 100)}..."`
            ).join('\n---\n');
            const userQuery = `להלן רשימה של ${window.allGreetings.length} ברכות יום הולדת לינאי. אנא כתוב סיכום קצר (עד 5 משפטים) ומרגש המדגיש את הנושאים העיקריים, את הטונים הבולטים (למשל, הומור, אהבה, הערכה) ואת הדבר המרכזי שהאורחים רוצים לאחל לו.`;
            const systemPrompt = `אתה אנליסט רגשות וסופר. כתוב סיכום אישי וחם בעברית על הברכות שקיבל ינאי ליום הולדתו ה-44, בהתבסס על הנתונים הבאים. השב רק בסיכום המרגש. הנתונים: \n\n${greetingData}`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${apiKey}`;

            try {
                const result = await fetchAI(apiUrl, payload);
                const summaryText = result.candidates?.[0]?.content?.parts?.[0]?.text || "לא ניתן היה ליצור סיכום. נסה שוב.";
                outputElement.innerHTML = `<p class="text-cyan-700 font-bold whitespace-pre-line">${summaryText}</p>`;
                showModal('הצלחה!', 'ניתוח הברכות הושלם בהצלחה!');
            } catch (e) {
                outputElement.innerHTML = `<p class="text-red-500">${e.message}</p>`;
                showModal('שגיאה', `שגיאה ביצירת הסיכום: ${e.message}`);
            }
            setButtonLoading('summary-button', false, 'הפק סיכום ברכות חכם');
        }
        window.generateGreetingsSummary = generateGreetingsSummary;
        
        // --- END AI GENERATION LOGIC ---

        // --- GREETING SUBMISSION LOGIC (Remains the same) ---
        
        document.getElementById('greeting-form').addEventListener('submit', handleGreetingSubmit);
        
        let selectedFiles = []; // Array to store file objects

        function handleFileSelection(input) {
            const files = Array.from(input.files);
            if (files.length > 3) {
                selectedFiles = files.slice(0, 3);
                showModal('שימו לב', "ניתן לבחור עד 3 קבצים בלבד. נבחרו רק שלושת הקבצים הראשונים.");
            } else {
                selectedFiles = files;
            }
            updateFileCountDisplay();
        }
        
        function fileToBase64(file) {
             return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = () => resolve({ data: reader.result.split(',')[1], mimeType: file.type, name: file.name });
                reader.readAsDataURL(file);
            });
        }
        
        // Simple recording stubs for UI functionality
        const recordButton = document.getElementById('record-button');
        const stopButton = document.getElementById('stop-button');
        const audioPreview = document.getElementById('audio-preview');

        if(recordButton) recordButton.onclick = () => { isRecording = true; recordButton.disabled = true; stopButton.disabled = false; recordButton.innerText = 'מקליט...'; };
        if(stopButton) stopButton.onclick = () => { isRecording = false; recordedBlob = new Blob(['dummy audio data'], { type: 'audio/wav' }); audioPreview.src = URL.createObjectURL(recordedBlob); audioPreview.classList.remove('hidden'); recordButton.disabled = false; stopButton.disabled = true; recordButton.innerText = 'התחל הקלטה'; updateFileCountDisplay(); };


        function updateFileCountDisplay() {
            const fileCount = selectedFiles.length;
            const audioCount = recordedBlob ? 1 : 0;
            document.getElementById('file-count').innerText = `${fileCount} קבצים ו-${audioCount} הקלטות מוכנים לשליחה.`;
        }

        async function handleGreetingSubmit(e) {
            e.preventDefault();
            const submitButton = document.getElementById('submit-greeting');
            submitButton.disabled = true;
            submitButton.innerText = 'מנתח טון ושולח ברכה...';

            const greeterName = document.getElementById('greeter-name').value;
            const greetingText = document.getElementById('greeting-text').value;

            if (!greeterName || !greetingText) {
                showModal('שגיאה', 'אנא מלא שם וברכה.');
                submitButton.disabled = false;
                submitButton.innerText = 'שלח את הברכה המיוחדת';
                return;
            }

            try {
                const analyzedTone = await analyzeTone(greetingText);
                
                let fileData = [];
                for (const file of selectedFiles) {
                    fileData.push(await fileToBase64(file));
                }

                let audioData = null;
                if (recordedBlob) {
                    audioData = await fileToBase64(recordedBlob);
                }

                const greeting = {
                    greeterName,
                    text: greetingText,
                    files: fileData, 
                    audio: audioData, 
                    tone: analyzedTone, 
                    likesCount: 0, 
                    replies: [], 
                    timestamp: serverTimestamp(),
                    senderId: window.userId 
                };

                await addDoc(window.getGreetingsCollectionRef(), greeting);

                document.getElementById('greeting-form').reset();
                selectedFiles = [];
                recordedBlob = null;
                audioPreview.classList.add('hidden');
                audioPreview.src = '';
                updateFileCountDisplay();

                showModal('הצלחה!', 'הברכה נשלחה בהצלחה!');

            } catch (error) {
                console.error("שגיאה בשליחת הברכה:", error);
                showModal('שגיאה בשליחה', `שגיאה בשליחת הברכה: ${error.message}.`);
            } finally {
                submitButton.disabled = false;
                submitButton.innerText = 'שלח את הברכה המיוחדת';
            }
        }
        
        // --- NEW: REPLY SUBMISSION LOGIC (Remains the same) ---
        window.handleReplySubmit = async (greetingId) => {
            const input = document.getElementById(`reply-input-${greetingId}`);
            const replyText = input.value.trim();
            const replyName = document.getElementById('greeter-name').value.trim() || 'אורח אנונימי'; // Use the main name field as sender name

            if (!replyText) {
                showModal('שגיאה', 'אנא כתוב תגובה לפני השליחה.');
                return;
            }
            
            const replyButton = document.getElementById(`reply-submit-${greetingId}`);
            replyButton.disabled = true;
            replyButton.innerText = 'שולח...';

            try {
                const docRef = window.doc(window.db, window.getGreetingsCollectionRef().path, greetingId);
                
                const newReply = {
                    name: replyName,
                    text: replyText,
                    timestamp: new Date().toISOString(), // Use simple ISO string for replies inside array
                    userId: window.userId
                };

                await window.updateDoc(docRef, {
                    replies: window.arrayUnion(newReply) // Atomically add to array
                });

                input.value = '';
                showModal('הצלחה!', 'התגובה נשלחה!');

            } catch (error) {
                console.error("Error submitting reply:", error);
                showModal('שגיאה', 'שגיאה בשליחת התגובה.');
            } finally {
                replyButton.disabled = false;
                replyButton.innerText = 'שלח תגובה';
                // Find the section element and collapse it
                const section = document.getElementById(`reply-section-${greetingId}`);
                if (section) section.style.maxHeight = '0'; 
            }
        }
        
        // Toggle Reply Box 
        window.toggleReplyBox = (greetingId, forceOpen = false) => {
            const section = document.getElementById(`reply-section-${greetingId}`);
            if (!section) return;

            if (forceOpen || section.style.maxHeight === '0px' || section.style.maxHeight === '') {
                // If opening, force the max height to scroll height for animation
                section.style.maxHeight = section.scrollHeight + 'px';
            } else {
                section.style.maxHeight = '0';
            }
        }

        // --- LIKE TOGGLE LOGIC (Remains the same) ---
        window.toggleLike = async (greetingId, currentLikes) => {
            if (!window.db || !window.userId) {
                console.error("Firestore not initialized.");
                showModal('שגיאה', 'מערכת הנתונים לא אותחלה. אנא רענן את הדף.');
                return;
            }

            const likeButton = document.getElementById(`like-icon-${greetingId}`);
            const likeCountElement = document.getElementById(`like-count-${greetingId}`);
            
            try {
                const docRef = window.doc(window.db, window.getGreetingsCollectionRef().path, greetingId);
                const newLikesCount = (currentLikes || 0) + 1;
                
                // Optimistic update and visual feedback
                likeCountElement.innerText = newLikesCount; 
                likeButton.classList.add('text-red-500', 'scale-125', 'animate-ping-once');
                
                setTimeout(() => {
                    likeButton.classList.remove('scale-125', 'animate-ping-once');
                }, 500);

                await window.updateDoc(docRef, {
                    likesCount: newLikesCount
                });

            } catch (error) {
                console.error("Error toggling like:", error);
                // Revert optimistic update
                likeCountElement.innerText = currentLikes;
                likeButton.classList.remove('text-red-500');
                showModal('שגיאה', 'לא ניתן היה לעדכן את כמות הלייקים כרגע.');
            }
        }


        // --- GREETING DISPLAY LOGIC (Remains the same) ---
        window.renderGreetings = (greetings) => {
            const list = document.getElementById('greetings-list');
            list.innerHTML = ''; 

            if (greetings.length === 0) {
                list.innerHTML = `<p class="text-gray-500 text-center p-4 bg-gray-100 rounded-lg">אין ברכות התואמות את הסינון הנוכחי.</p>`;
                return;
            }

            greetings.forEach(g => {
                const greetingCard = document.createElement('div');
                greetingCard.className = 'p-5 border-2 border-red-300 rounded-xl shadow-md bg-white space-y-3';
                
                let fileHtml = '';
                if (g.files && g.files.length > 0) {
                    fileHtml = '<div class="flex flex-wrap gap-2 mt-2 border-t pt-2 border-gray-100">';
                    g.files.forEach(file => {
                        const mime = file.mimeType || '';
                        const base64Url = `data:${mime};base64,${file.data}`;
                        
                        if (mime.startsWith('image/')) {
                            fileHtml += `<img src="${base64Url}" alt="${file.name}" class="w-24 h-24 object-cover rounded-md shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/96x96/f0f4f8/94a3b8?text=תמונה+חסרה'">`;
                        } else if (mime.startsWith('audio/')) {
                            fileHtml += `
                                <div class="p-2 border rounded-md bg-gray-50">
                                    <p class="text-xs text-gray-500">${file.name || 'קובץ שמע'}</p>
                                    <audio controls src="${base64Url}" class="w-full mt-1"></audio>
                                </div>`;
                        } else if (mime.startsWith('video/')) {
                            fileHtml += `
                                <video controls src="${base64Url}" class="w-32 h-32 object-cover rounded-md shadow-sm bg-black" poster="https://placehold.co/128x128/f0f4f8/94a3b8?text=וידאו" >
                                    הדפדפן שלך לא תומך בווידאו.
                                </video>`;
                        } else {
                            fileHtml += `<div class="text-xs p-2 bg-gray-100 rounded-md">קובץ מצורף: ${file.name}</div>`;
                        }
                    });
                    fileHtml += '</div>';
                }

                // Render attached audio recording
                let audioHtml = '';
                if (g.audio && g.audio.data) {
                    const audioUrl = `data:${g.audio.mimeType};base64,${g.audio.data}`;
                    audioHtml = `
                        <div class="mt-3 p-3 border-t border-gray-100">
                            <p class="text-sm font-semibold text-gray-700">🎧 הקלטה קולית:</p>
                            <audio controls src="${audioUrl}" class="w-full mt-1"></audio>
                        </div>`;
                }
                
                // Render Replies
                let repliesHtml = '';
                if (g.replies && g.replies.length > 0) {
                    repliesHtml = `
                        <div class="mt-4 pt-3 border-t border-gray-200">
                            <p class="text-sm font-bold text-gray-700 mb-2">תגובות (${g.replies.length}):</p>
                            <div class="space-y-2 max-h-40 overflow-y-auto pr-2" dir="rtl">
                                ${g.replies.map(reply => `
                                    <div class="p-2 bg-gray-50 rounded-lg border border-gray-200 shadow-sm">
                                        <div class="flex justify-between items-center text-xs text-gray-500">
                                            <span class="font-semibold text-gray-700">${reply.name}</span>
                                            <span>${new Date(reply.timestamp).toLocaleDateString('he-IL')}</span>
                                        </div>
                                        <p class="text-sm text-gray-600 mt-1">${reply.text}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                }

                const timestamp = g.timestamp?.toDate ? g.timestamp.toDate().toLocaleDateString('he-IL') : 'מיד עכשיו';
                const tone = g.tone || "לא נותח";
                const likesCount = g.likesCount || 0; 

                // Escape backticks in text for safe function call (g.text might contain single/double quotes)
                const safeGreetingText = g.text.replace(/`/g, '\\`');

                greetingCard.innerHTML = `
                    <div class="flex justify-between items-center border-b pb-2 mb-2">
                        <h4 class="text-xl font-extrabold text-red-800">${g.greeterName}</h4>
                        <div class="flex items-center space-x-2 space-x-reverse text-right">
                            <span class="text-sm font-semibold bg-blue-100 text-blue-800 px-3 py-1 rounded-full shadow-sm">
                                טון: ${tone} 🤖
                            </span>
                            <span class="text-sm text-gray-500">${timestamp}</span>
                        </div>
                    </div>
                    <p class="text-gray-700 whitespace-pre-line">${g.text}</p>
                    ${fileHtml}
                    ${audioHtml}
                    ${repliesHtml}
                    
                    <!-- Control and Reply Section -->
                    <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-100">
                        <!-- Like Button -->
                        <button onclick="toggleLike('${g.id}', ${likesCount})" class="text-gray-500 hover:text-red-500 transition duration-150 flex items-center gap-1">
                            <span id="like-icon-${g.id}" class="${likesCount > 0 ? 'text-red-500' : 'text-gray-500'}">❤️</span>
                            <span id="like-count-${g.id}" class="font-bold">${likesCount}</span>
                            <span class="text-sm">אהבתי</span>
                        </button>
                        
                        <!-- Reply Button -->
                        <button onclick="toggleReplyBox('${g.id}')" class="text-sm px-3 py-1 bg-red-100 text-red-700 rounded-full hover:bg-red-200 transition duration-150">
                            הגב/י
                        </button>
                    </div>
                    
                    <!-- Reply Input Section (NEW) -->
                    <div id="reply-section-${g.id}" class="reply-section max-h-0 bg-gray-50 p-3 rounded-lg border border-gray-200 mt-2">
                        <div class="flex gap-2 mb-2">
                            <!-- NEW AI REPLY BUTTON -->
                            <button id="ai-reply-button-${g.id}" onclick="generateAIReply('${g.id}', '${g.greeterName}', \`${safeGreetingText}\`)" class="flex-1 text-sm px-4 py-1 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition duration-150 disabled:bg-indigo-300">
                                🤖 צור תגובת AI
                            </button>
                            <button id="clear-reply-button-${g.id}" onclick="document.getElementById('reply-input-${g.id}').value=''" class="text-sm px-4 py-1 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition duration-150">
                                נקה
                            </button>
                        </div>
                        <textarea id="reply-input-${g.id}" rows="2" class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 resize-none" placeholder="כתוב תגובה כאן..." dir="rtl"></textarea>
                        <button id="reply-submit-${g.id}" onclick="handleReplySubmit('${g.id}')" class="mt-2 text-sm px-4 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150 disabled:bg-red-300">
                            שלח תגובה
                        </button>
                    </div>
                `;
                list.appendChild(greetingCard);
            });
        };

        // Initialize sort and wish counter after the DOM is loaded
        window.addEventListener('load', () => {
             updateTopWishes(); 
        });

    </script>

    <!-- Tailwind Config for Custom Colors/Fonts -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': {
                            500: '#ef4444', 
                            700: '#b91c1c',
                        },
                    }
                }
            }
        }
    </script>
</body>
</html>
