
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> 转 砖, !</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom Hebrew Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- Firebase Imports for Firestore and Auth -->
    <!--  拽 转  拽   注 砖转 /砖 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 专转 转 住转 注 ( 砖转砖 )
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        window.db = null;
        window.auth = null;
        window.currentUserId = null;
        window.collectionPath = `artifacts/${appId}/public/data/birthday_blessings`;

        // 转 Firebase 转专转
        async function initFirebase() {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = '...转 专 住 转';
            statusEl.classList.remove('hidden', 'text-red-600');
            statusEl.classList.add('text-yellow-600');

            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase configuration is missing.");
                    statusEl.textContent = '砖: 专转 Firebase 住专转.';
                    statusEl.classList.remove('text-yellow-600');
                    statusEl.classList.add('text-red-600');
                    return;
                }

                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                setLogLevel('Debug'); // 爪转  驻专 -Console
                
                // 注 住住 专 转 爪
                statusEl.textContent = '转 转 砖转砖...';
                statusEl.classList.remove('text-yellow-600');
                statusEl.classList.add('text-blue-600');

                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                onAuthStateChanged(window.auth, (user) => {
                    const userIdDisplayEl = document.getElementById('user-id-display');

                    if (user) {
                        window.currentUserId = user.uid;
                        console.log("User authenticated. UID:", window.currentUserId);
                        userIdDisplayEl.textContent = ` 砖转砖: ${window.currentUserId}`;
                        statusEl.textContent = '专 爪. 注 专转.';
                        statusEl.classList.remove('text-blue-600');
                        statusEl.classList.add('text-green-600');
                        userIdDisplayEl.classList.remove('hidden');
                    } else {
                        window.currentUserId = crypto.randomUUID();
                        console.log("Anonymous user ID generated:", window.currentUserId);
                        userIdDisplayEl.textContent = ` 砖转砖 : ${window.currentUserId}`;
                        statusEl.textContent = '专 . 注 专转.';
                        statusEl.classList.remove('text-blue-600');
                        statusEl.classList.add('text-green-600');
                        userIdDisplayEl.classList.remove('hidden');
                    }
                    // 转  专转 专拽 专 住 转 专砖
                    listenForBlessings();
                });

            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                const errorEl = document.getElementById('success-message');
                errorEl.textContent = '砖转 转专转 注专转. 住 专注.';
                errorEl.classList.remove('hidden', 'text-green-600');
                errorEl.classList.add('text-red-600');
                
                // 注 住住 砖
                statusEl.textContent = '砖 专: 砖 转 Firebase.';
                statusEl.classList.remove('hidden', 'text-yellow-600', 'text-blue-600', 'text-green-600');
                statusEl.classList.add('text-red-600');
            }
        }
        
        // 驻拽爪转  转 爪转
        let isInitialLoad = true;
        function listenForBlessings() {
            if (!window.db) return;

            const q = query(collection(window.db, window.collectionPath));

            onSnapshot(q, (snapshot) => {
                const blessingsContainer = document.getElementById('blessings-container');
                const galleryContainer = document.getElementById('gallery-container');
                const loadingMessage = document.getElementById('loading-message');
                
                // 住专转 注转 注 专 砖转 转 注 驻注 专砖
                if (isInitialLoad && loadingMessage) {
                    loadingMessage.remove();
                    isInitialLoad = false;
                }
                
                // 拽 专拽 转 专转 转转 砖住驻 转 (砖专 转 住转)
                const dynamicElements = document.querySelectorAll('.dynamic-item');
                dynamicElements.forEach(el => el.remove());

                const allBlessings = [];
                snapshot.forEach((doc) => {
                    allBlessings.push({ id: doc.id, ...doc.data() });
                });
                
                //  爪 拽 驻 转转  (注驻 注 驻 orderBy -Firestore)
                allBlessings.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

                allBlessings.forEach(data => {
                    // 爪转 专
                    if (data.blessingText) {
                        const newBlessing = document.createElement('blockquote');
                        newBlessing.classList.add('dynamic-item');
                        newBlessing.innerHTML = `
                            <p>"${data.blessingText}"</p>
                            <footer>- ${data.senderName || ''}</footer>
                        `;
                        blessingsContainer.appendChild(newBlessing);
                    }

                    // 爪转 转
                    if (data.base64Image) {
                        const newImageContainer = document.createElement('div');
                        newImageContainer.className = 'bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300 dynamic-item';
                        newImageContainer.innerHTML = `
                            <img src="${data.base64Image}" alt="转 -${data.senderName}" class="w-full h-48 object-cover">
                            <p class="p-3 text-center text-slate-600">转 砖 : ${data.senderName || ''}</p>
                        `;
                        galleryContainer.appendChild(newImageContainer);
                    }
                });
                
                //   专 专 砖转住驻
                blessingsContainer.scrollTop = blessingsContainer.scrollHeight;
            }, (error) => {
                console.error("Error fetching data:", error);
            });
        }
        
        // --- 拽转 驻拽爪 (拽驻 驻住) ---

        // 住拽专驻 拽驻
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('confetti-container');
            const confettiCount = 100;
            const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6'];
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = `${Math.random() * 5}s`;
                const size = Math.random() * 5 + 5;
                confetti.style.width = `${size}px`;
                confetti.style.height = `${size}px`;
                container.appendChild(confetti);
            }
            
            // 驻注转 转 Firebase 专 注转 -DOM
            initFirebase();
        });

        // 驻拽爪 专转 拽抓 转 -Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = (error) => reject(error);
            });
        }

        // 拽 砖转 驻住 -Firestore
        const blessingForm = document.getElementById('blessing-form');
        const successMessage = document.getElementById('success-message');
        const submitButton = document.getElementById('submit-button');

        if (blessingForm) {
            blessingForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                
                if (!window.db) {
                    console.error("Firestore not initialized.");
                    return;
                }

                // 爪 注转 注 砖转 驻转专
                submitButton.disabled = true;
                submitButton.textContent = '...砖 专';
                successMessage.classList.add('hidden');
                
                const senderName = document.getElementById('sender-name').value.trim();
                const blessingText = document.getElementById('blessing-text').value.trim();
                const imageFile = document.getElementById('image-upload').files[0];

                if (!senderName || !blessingText) {
                    submitButton.disabled = false;
                    submitButton.textContent = '住驻 转 专';
                    return;
                }

                let base64Image = null;
                if (imageFile) {
                    try {
                        // Base64 驻砖专 住 转 砖专转 -Firestore.
                        // 砖 : 砖  砖 1MB  住.
                        base64Image = await fileToBase64(imageFile);
                    } catch (error) {
                        console.error("Error converting image to Base64:", error);
                        // 砖  转  砖 砖
                    }
                }

                const blessingData = {
                    senderName: senderName,
                    blessingText: blessingText,
                    base64Image: base64Image,
                    // 砖转砖 砖专转 -serverTimestamp  注
                    timestamp: serverTimestamp(), 
                    userId: window.currentUserId
                };

                try {
                    // 砖专转 专 拽拽爪 爪专转
                    await addDoc(collection(window.db, window.collectionPath), blessingData);
                    
                    successMessage.classList.remove('hidden', 'text-red-600');
                    successMessage.classList.add('text-green-600');
                    successMessage.textContent = '转! 专 住驻 爪, 转注...';
                    blessingForm.reset(); // 驻住 驻住
                } catch (error) {
                    console.error("Error adding document:", error);
                    successMessage.classList.remove('hidden', 'text-green-600');
                    successMessage.classList.add('text-red-600');
                    successMessage.textContent = '砖 砖专转 专. 拽 转 拽住 (Console).';
                } finally {
                    // 专转 驻转专 爪 专
                    submitButton.disabled = false;
                    submitButton.textContent = '住驻 转 专';
                    // 住转专转 注转 爪 专 3 砖转
                    setTimeout(() => { successMessage.classList.add('hidden'); }, 3000);
                }
            });
        }
    </script>

    <style>
        body {
            font-family: 'Assistant', sans-serif;
            overflow-x: hidden; /* 注  驻拽转  拽驻 */
        }
        /* 注爪 拽驻 */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f00;
            opacity: 0.7;
            border-radius: 50%;
            animation: fall 5s linear infinite;
            top: -20px; /* 转 注 住 */
            z-index: 10;
        }
        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        /* 注爪 专转 (blockquote) */
        blockquote {
            background-color: #f8fafc;
            border-right: 5px solid #0ea5e9;
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
            transition: all 0.3s ease-in-out;
        }
        blockquote:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        blockquote p {
            font-style: italic;
        }
        blockquote footer {
            text-align: left;
            margin-top: 0.5rem;
            font-weight: bold;
            color: #475569;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="confetti-container"></div>

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        
        <!-- 转专转 专砖转 -->
        <header class="text-center my-8 md:my-12">
            <h1 class="text-4xl md:text-6xl font-bold text-sky-600">  转 砖, ! </h1>
            <p class="text-2xl md:text-3xl mt-4 text-slate-600">   转 44!</p>
            <!-- 专 住住 专 - 住祝 砖   -->
            <div id="status-message" class="text-sm mt-2 text-red-500 font-semibold hidden"></div>
            <p id="user-id-display" class="text-xs text-slate-400 mt-2 hidden"> 砖转砖:</p>
        </header>

        <main>
            <!-- 拽注 专 砖转 - 注  转 砖 砖! -->
            <section class="bg-white rounded-lg shadow-lg p-6 md:p-8 mb-8 text-center">
                <h2 class="text-2xl font-bold mb-4 text-sky-800">专 砖转 </h2>
                <p class="text-lg leading-relaxed">
                     拽专, 专爪转   转   砖注. 转    砖砖, 转 转,  爪拽.
                       注专 转   砖注砖转 转 注砖 砖 砖 .   砖 专转 砖 专转, 砖专, 转 砖转  转.
                     ,
                </p>
                <p class="mt-4 font-bold text-xl">- [砖 砖] -</p>
            </section>

            <!-- 专 专转 转 -->
            <h2 class="text-3xl font-bold text-center mb-6 text-sky-800"> 专转 专砖转!</h2>
            <section id="blessings-container" class="mb-8 p-4 bg-white rounded-lg shadow-inner max-h-96 overflow-y-auto">
                <p class="text-center text-slate-500 italic" id="loading-message">...注 专转 注转</p>
            </section>

            <!-- 专转 转转 -->
            <section class="mb-8">
                <h2 class="text-3xl font-bold text-center mb-6 text-sky-800">专转 专转 砖转驻转</h2>
                <div id="gallery-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- 转转 住转 拽转 -->
                    <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300">
                        <img src="https://placehold.co/600x400/3498db/ffffff?text=转+砖驻转转" alt="转 砖驻转转" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/3498db/ffffff?text=Loading+Error'">
                        <p class="p-3 text-center text-slate-600">转专 拽爪专 砖 转</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300">
                        <img src="https://placehold.co/600x400/e74c3c/ffffff?text=转+" alt="转 " class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e74c3c/ffffff?text=Loading+Error'">
                        <p class="p-3 text-center text-slate-600">注 专 转拽</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300">
                        <img src="https://placehold.co/600x400/2ecc71/ffffff?text=转+爪拽" alt="转 爪拽" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/2ecc71/ffffff?text=Loading+Error'">
                        <p class="p-3 text-center text-slate-600"> 转 爪拽</p>
                    </div>
                    <!-- 转转 砖转住驻 注  砖转砖 驻注  驻  -->
                </div>
            </section>

            <!-- 驻住 住驻转 专 转 -->
            <section class="bg-sky-50 rounded-lg shadow-lg p-6 md:p-8 text-center border-2 border-sky-200">
                <h2 class="text-2xl font-bold mb-4 text-sky-800">住驻 专 转 砖!</h2>
                <form id="blessing-form" class="flex flex-col gap-4 max-w-lg mx-auto text-right">
                    <input type="text" id="sender-name" placeholder="砖 砖 ()" class="w-full p-2 border border-slate-300 rounded-md" required>
                    <textarea id="blessing-text" placeholder="专 砖... ()" rows="4" class="w-full p-2 border border-slate-300 rounded-md" required></textarea>
                    <div>
                        <label for="image-upload" class="block mb-2 font-medium">专爪 住祝  转? (驻爪)</label>
                        <input type="file" id="image-upload" accept="image/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-100 file:text-sky-700 hover:file:bg-sky-200">
                        <p class="text-xs text-slate-500 mt-1">砖 :  转   爪专 砖专 住 转.</p>
                    </div>
                    <button type="submit" id="submit-button" class="bg-sky-600 text-white font-bold py-3 px-8 rounded-full hover:bg-sky-700 transition-colors duration-300 text-lg shadow-md w-full">
                        住驻 转 专
                    </button>
                </form>
                <p id="success-message" class="text-green-600 mt-4 font-bold hidden">转! 专 住驻 爪, 转注...</p>
            </section>
        </main>
        
        <footer class="text-center mt-12 mb-6">
            <!-- 住驻转 专 住专 砖注转  驻转 专注 拽砖 -->
            <p class="text-slate-500">  注  [砖 砖], 2025 &nbsp;</p>
        </footer>

    </div>
</body>
</html>
