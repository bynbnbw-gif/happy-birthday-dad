<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>יום הולדת שמח, ינאי!</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom Hebrew Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght=300;400;700&display=swap" rel="stylesheet">
    
    <!-- Firebase Imports for Firestore and Auth -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // נשארו רק הפונקציות ההכרחיות לאימות פנימי שקט
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // גישה מאובטחת למשתנים הגלובליים
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        window.db = null;
        window.auth = null;
        window.currentUserId = null;
        window.collectionPath = `artifacts/${appId}/public/data/birthday_blessings`;

        let unsubscribeBlessings = null;
        let retryTimeoutId = null; 
        let isInitialLoad = true;
        
        // --- לוגיקת אתחול ואימות שקטה (ללא UI) ---
        
        async function initFirebase() {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = '...מאתחל חיבור שיתופי';

            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase configuration is missing.");
                    statusEl.textContent = 'שגיאה: הגדרות Firebase חסרות.';
                    return;
                }

                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                setLogLevel('Debug'); 
                
                // אימות שקט ברקע - חובה לגישה ל-Firestore
                await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(window.auth, async (user) => {
                        if (user) {
                            window.currentUserId = user.uid;
                            unsubscribe();
                            startBlessingsListenerWithRetry(statusEl); // מתחיל טעינת נתונים
                            resolve();
                            return;
                        }

                        // אם אין משתמש, מנסים להתחבר בצורה אנונימית/טוקן
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(window.auth, initialAuthToken);
                            } else {
                                await signInAnonymously(window.auth);
                            }
                        } catch(e) {
                            console.error("Initial sign-in failed, the app will not function correctly:", e);
                        }
                        
                        unsubscribe();
                        resolve();
                    });
                });
                
                // הסרת כיבוי הטופס אם האימות הצליח בשקט
                document.getElementById('form-container').classList.remove('opacity-50', 'pointer-events-none');

            } catch (error) {
                console.error("Fatal error during Firebase initialization:", error);
                statusEl.textContent = 'שגיאה חמורה: נכשל אתחול Firebase.';
                statusEl.classList.add('text-red-600');
            }
        }

        // --- לוגיקת האזנה ועדכון נתונים (נשארה זהה) ---
        
        function cleanupListener() {
            if (unsubscribeBlessings) {
                unsubscribeBlessings();
                unsubscribeBlessings = null;
            }
            if (retryTimeoutId) {
                clearTimeout(retryTimeoutId);
                retryTimeoutId = null;
            }
        }
        
        function startBlessingsListenerWithRetry(statusEl) {
            if (!window.db) return;

            const MAX_RETRIES = 5;
            let currentRetry = 0;
            
            const attemptListen = () => {
                const q = query(collection(window.db, window.collectionPath));
                
                if (unsubscribeBlessings) {
                    unsubscribeBlessings();
                    unsubscribeBlessings = null;
                }

                unsubscribeBlessings = onSnapshot(q, (snapshot) => {
                    if (retryTimeoutId) {
                        clearTimeout(retryTimeoutId);
                        retryTimeoutId = null;
                    }
                    currentRetry = 0; 
                    
                    // עדכון סטטוס הצלחה
                    statusEl.textContent = 'החיבור לנתונים פעיל. הברכות טעונות.';
                    statusEl.classList.remove('text-red-600', 'text-yellow-600');
                    statusEl.classList.add('text-green-600');

                    const blessingsContainer = document.getElementById('blessings-container');
                    const galleryContainer = document.getElementById('gallery-container');
                    const loadingMessage = document.getElementById('loading-message');
                    
                    if (isInitialLoad && loadingMessage) {
                        loadingMessage.remove();
                        isInitialLoad = false;
                    }
                    
                    const dynamicElements = document.querySelectorAll('.dynamic-item');
                    dynamicElements.forEach(el => el.remove());

                    const allBlessings = [];
                    snapshot.forEach((doc) => {
                        allBlessings.push({ id: doc.id, ...doc.data() });
                    });
                    
                    allBlessings.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

                    allBlessings.forEach(data => {
                        if (data.blessingText) {
                            const newBlessing = document.createElement('blockquote');
                            newBlessing.classList.add('dynamic-item', 'transition-opacity', 'duration-500');
                            newBlessing.innerHTML = `
                                <p>"${data.blessingText}"</p>
                                <footer>- ${data.senderName || 'אנונימי'}</footer>
                            `;
                            blessingsContainer.appendChild(newBlessing);
                        }

                        if (data.base64Image) {
                            const newImageContainer = document.createElement('div');
                            newImageContainer.className = 'bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300 dynamic-item';
                            newImageContainer.innerHTML = `
                                <img src="${data.base64Image}" alt="תמונה מ-${data.senderName}" class="w-full h-48 object-cover">
                                <p class="p-3 text-center text-slate-600">תמונה חדשה מ: ${data.senderName || 'אנונימי'}</p>
                            `;
                            galleryContainer.appendChild(newImageContainer);
                        }
                    });
                    
                    blessingsContainer.scrollTop = blessingsContainer.scrollHeight;

                }, (error) => {
                    // כשל: טיפול בשגיאת הרשאה
                    if (error.code === 'permission-denied' && currentRetry < MAX_RETRIES) {
                        currentRetry++;
                        const delay = 2 ** currentRetry * 100 + Math.random() * 100;
                        
                        console.log(`Permission denied. Retrying in ${delay.toFixed(0)}ms (Attempt ${currentRetry}/${MAX_RETRIES}).`);
                        
                        if (unsubscribeBlessings) {
                            unsubscribeBlessings();
                            unsubscribeBlessings = null;
                        }

                        retryTimeoutId = setTimeout(attemptListen, delay);
                    } else {
                        // כשל קבוע 
                        console.error("Fatal Error fetching data:", error);
                        statusEl.textContent = 'שגיאה קבועה בטעינת הברכות.';
                        statusEl.classList.add('text-red-600');
                        if (unsubscribeBlessings) {
                            unsubscribeBlessings();
                            unsubscribeBlessings = null;
                        }
                    }
                });
            };

            retryTimeoutId = setTimeout(attemptListen, 50); 
        }
        
        // --- לוגיקת האפליקציה (קונפטי וטופס) ---

        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('confetti-container');
            const confettiCount = 100;
            const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6'];
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = `${Math.random() * 5}s`;
                const size = Math.random() * 5 + 5;
                confetti.style.width = `${size}px`;
                confetti.style.height = `${size}px`;
                container.appendChild(confetti);
            }
            
            initFirebase();
            
            // אין יותר הצמדת פונקציות לכפתורי אימות
            
            setupFormSubmission();
        });

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = (error) => reject(error);
            });
        }

        function setupFormSubmission() {
            const blessingForm = document.getElementById('blessing-form');
            const successMessage = document.getElementById('success-message');
            const submitButton = document.getElementById('submit-button');
            
            if (!blessingForm) return;

            blessingForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                
                if (!window.db) {
                    document.getElementById('success-message').textContent = 'שגיאה: מסד הנתונים אינו מחובר.';
                    document.getElementById('success-message').classList.remove('hidden', 'text-green-600');
                    document.getElementById('success-message').classList.add('text-red-600');
                    return;
                }

                submitButton.disabled = true;
                submitButton.textContent = '...שולח ברכה';
                successMessage.classList.add('hidden');
                
                const senderName = document.getElementById('sender-name').value.trim();
                const blessingText = document.getElementById('blessing-text').value.trim();
                const imageFile = document.getElementById('image-upload').files[0];

                if (!senderName || !blessingText) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'הוסיפו את הברכה';
                    document.getElementById('success-message').textContent = 'נא למלא שם וברכה.';
                    document.getElementById('success-message').classList.remove('hidden', 'text-green-600');
                    document.getElementById('success-message').classList.add('text-red-600');
                    return;
                }

                let base64Image = null;
                if (imageFile) {
                    try {
                        base64Image = await fileToBase64(imageFile);
                    } catch (error) {
                        console.error("Error converting image to Base64:", error);
                    }
                }

                const blessingData = {
                    senderName: senderName,
                    blessingText: blessingText,
                    base64Image: base64Image,
                    timestamp: serverTimestamp(), 
                    userId: window.currentUserId || 'anonymous_unknown' // שימוש ב-UID אם קיים, אחרת מזהה חלופי
                };

                try {
                    await addDoc(collection(window.db, window.collectionPath), blessingData);
                    
                    successMessage.classList.remove('hidden', 'text-red-600');
                    successMessage.classList.add('text-green-600');
                    successMessage.textContent = 'תודה! הברכה נוספה בהצלחה, מתעדכן...';
                    blessingForm.reset();
                } catch (error) {
                    console.error("Error adding document:", error);
                    successMessage.classList.remove('hidden', 'text-green-600');
                    successMessage.classList.add('text-red-600');
                    successMessage.textContent = 'שגיאה בשמירת הברכה. נסה שוב מאוחר יותר.';
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'הוסיפו את הברכה';
                    setTimeout(() => { successMessage.classList.add('hidden'); }, 3000);
                }
            });
        }
    </script>

    <style>
        body {
            font-family: 'Assistant', sans-serif;
            overflow-x: hidden;
            direction: rtl; /* כיווניות מימין לשמאל */
            text-align: right;
        }
        /* עיצוב קונפטי */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f00;
            opacity: 0.7;
            border-radius: 50%;
            animation: fall 5s linear infinite;
            top: -20px;
            z-index: 10;
        }
        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        /* עיצוב הברכות (blockquote) */
        blockquote {
            background-color: #f8fafc;
            border-right: 5px solid #0ea5e9;
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
            transition: all 0.3s ease-in-out;
            text-align: right;
        }
        blockquote:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        blockquote p {
            font-style: italic;
        }
        blockquote footer {
            text-align: left; /* שם השולח יהיה בצד שמאל */
            margin-top: 0.5rem;
            font-weight: bold;
            color: #475569;
        }
    </style>
</head>
<body class="bg-cyan-50 text-slate-800">

    <div id="confetti-container"></div>

    <div class="container mx-auto p-4 md:p-8 max-w-4xl bg-white rounded-2xl shadow-2xl border-4 border-cyan-400">
        
        <!-- בקרות אימות וסטטוס - הוסרו לחלוטין -->

        <!-- כותרת ראשית -->
        <header class="text-center my-8 md:my-12 p-6 rounded-xl bg-sky-100 shadow-xl">
            <h1 class="text-4xl md:text-6xl font-bold text-sky-700">🎉 יום הולדת שמח, ינאי! 🎉</h1>
            <p class="text-2xl md:text-3xl mt-4 text-slate-700">חוגגים לך יום הולדת 44!</p>
            <!-- ניטור סטטוס חיבור פשוט ל-Firestore בלבד -->
            <div id="status-message" class="text-sm mt-2 text-green-500 font-semibold">...מאתחל חיבור שיתופי</div>
        </header>

        <main>
            <!-- קטע ברכה אישית - עדכנו כאן את השם שלכם! -->
            <section class="bg-white rounded-lg shadow-lg p-6 md:p-8 mb-8 text-center">
                <h2 class="text-2xl font-bold mb-4 text-sky-800">ברכה אישית ממני</h2>
                <p class="text-lg leading-relaxed">
                    ינאי היקר, רציתי לאחל לך את כל הטוב שבעולם. אתה האבא הכי מדהים שיש, תמיד תומך, מלמד ומצחיק.
                    אני כל כך מעריך את כל מה שעשית ואתה עושה בשבילי ובשביל כולנו. מאחל לך שנים רבות של בריאות, אושר, נחת והגשמת כל החלומות.
                    אוהב המון,
                </p>
                <p class="mt-4 font-bold text-xl">- אבישי-</p>
            </section>

            <!-- אזור הברכות הדינמיות -->
            <h2 class="text-3xl font-bold text-center mb-6 text-sky-800">כל הברכות המרגשות!</h2>
            <section id="blessings-container" class="mb-8 p-4 bg-white rounded-lg shadow-inner max-h-96 overflow-y-auto">
                <p class="text-center text-slate-500 italic" id="loading-message">...טוען ברכות עדכניות</p>
            </section>

            <!-- גלריית תמונות -->
            <section class="mb-8">
                <h2 class="text-3xl font-bold text-center mb-6 text-sky-800">גלריית זיכרונות משותפת</h2>
                <div id="gallery-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- תמונות סטטיות קיימות -->
                    <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300">
                        <img src="https://placehold.co/600x400/3498db/ffffff?text=תמונה+משפחתית" alt="תמונה משפחתית" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/3498db/ffffff?text=Loading+Error'">
                        <p class="p-3 text-center text-slate-600">תיאור קצר של התמונה</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300">
                        <img src="https://placehold.co/600x400/e74c3c/ffffff?text=תמונה+מטיול" alt="תמונה מטיול" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e74c3c/ffffff?text=Loading+Error'">
                        <p class="p-3 text-center text-slate-600">עוד זיכרון מתוק</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300">
                        <img src="https://placehold.co/600x400/2ecc71/ffffff?text=תמונה+מצחיקה" alt="תמונה מצחיקה" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/2ecc71/ffffff?text=Loading+Error'">
                        <p class="p-3 text-center text-slate-600">וכמובן תמונה מצחיקה</p>
                    </div>
                    <!-- תמונות שיתווספו על ידי משתמשים יופיעו כאן באופן דינמי -->
                </div>
            </section>

            <!-- טופס הוספת ברכה ותמונה -->
            <section id="form-container" class="bg-sky-50 rounded-lg shadow-lg p-6 md:p-8 text-center border-2 border-sky-200 transition-opacity duration-300">
                <h2 class="text-2xl font-bold mb-4 text-sky-800">הוסיפו ברכה ותמונה משלכם!</h2>
                <form id="blessing-form" class="flex flex-col gap-4 max-w-lg mx-auto text-right">
                    <input type="text" id="sender-name" placeholder="השם שלכם (חובה)" class="w-full p-2 border border-slate-300 rounded-md" required>
                    <textarea id="blessing-text" placeholder="הברכה שלכם... (חובה)" rows="4" class="w-full p-2 border border-slate-300 rounded-md" required></textarea>
                    <div>
                        <label for="image-upload" class="block mb-2 font-medium">רוצים להוסיף גם תמונה? (אופציונלי)</label>
                        <input type="file" id="image-upload" accept="image/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-100 file:text-sky-700 hover:file:bg-sky-200">
                        <p class="text-xs text-slate-500 mt-1">שימו לב: גודל תמונה מוגבל מאוד לצורך שמירה במסד הנתונים.</p>
                    </div>
                    <button type="submit" id="submit-button" class="bg-sky-600 text-white font-bold py-3 px-8 rounded-full hover:bg-sky-700 transition-colors duration-300 text-lg shadow-md w-full">
                        הוסיפו את הברכה
                    </button>
                </form>
                <p id="success-message" class="text-green-600 mt-4 font-bold hidden">תודה! הברכה נוספה בהצלחה, מתעדכן...</p>
            </section>
        </main>
        
        <footer class="text-center mt-12 mb-6">
            <p class="text-slate-500">נבנה באהבה על ידי אבישי, 2025</p>
        </footer>

    </div>
</body>
</html>
